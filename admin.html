<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latiao Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e62117;
            --primary-dark: #c41c13;
            --primary-light: #fff0f0;
            --bg-body: #f0f2f5;
            --bg-sidebar: #ffffff;
            --bg-chat: #efeae2; /* –ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É —è–∫ —É –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö */
            --white: #ffffff;
            --text-main: #111b21;
            --text-sec: #667781;
            --border: #e9edef;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --bubble-user: #ffffff;
            --bubble-admin: #e62117; /* –¢–≤—ñ–π –±—Ä–µ–Ω–¥–æ–≤–∏–π —á–µ—Ä–≤–æ–Ω–∏–π */
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            height: 100vh; overflow: hidden;
            color: var(--text-main);
        }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 70px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding: 15px 0; z-index: 100;
        }
        .logo { 
            font-size: 24px; margin-bottom: 30px; width: 44px; height: 44px;
            background: var(--primary-light); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: default;
        }
        .nav-item {
            width: 44px; height: 44px; margin-bottom: 10px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-sec); cursor: pointer; transition: 0.2s; position: relative;
        }
        .nav-item:hover { background: #f5f5f5; color: var(--primary); }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(230, 33, 23, 0.3); }
        .nav-item svg { width: 22px; height: 22px; stroke-width: 2; }
        
        /* TOOLTIP */
        .tooltip {
            position: absolute; left: 55px; background: #333; color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none;
            white-space: nowrap; transition: 0.2s; z-index: 101;
        }
        .nav-item:hover .tooltip { opacity: 1; left: 60px; }

        /* MAIN AREA */
        .main-content { flex: 1; position: relative; overflow: hidden; background: #fff; }
        .view-section { width: 100%; height: 100%; display: none; }
        .view-section.active { display: flex; }

        /* --- CHATS VIEW --- */
        .chats-layout { display: flex; width: 100%; height: 100%; }

        /* Chat List */
        .chat-list-panel {
            width: 350px; background: #fff; border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .cl-header { padding: 16px; border-bottom: 1px solid var(--border); background: #f7f7f8; }
        .cl-title { font-size: 20px; font-weight: 700; margin: 0 0 12px 0; }
        .cl-filters { display: flex; background: #e3e5e8; padding: 3px; border-radius: 8px; }
        .filter-btn {
            flex: 1; text-align: center; padding: 6px; font-size: 13px; font-weight: 500;
            border-radius: 6px; cursor: pointer; color: #555; transition: 0.2s;
        }
        .filter-btn.active { background: #fff; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .cl-items { flex: 1; overflow-y: auto; }
        .c-item {
            padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer;
            display: flex; gap: 12px; transition: background 0.2s;
        }
        .c-item:hover { background: #f5f5f5; }
        .c-item.active { background: #fff5f5; border-left: 4px solid var(--primary); }
        
        .c-avatar {
            width: 42px; height: 42px; border-radius: 50%; background: #dfe1e5;
            color: #555; font-weight: 600; display: flex; align-items: center; justify-content: center;
            font-size: 16px; flex-shrink: 0;
        }
        .c-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .c-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .c-name { font-weight: 600; font-size: 15px; color: var(--text-main); }
        .c-time { font-size: 11px; color: var(--text-sec); }
        .c-msg { font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-manager { font-size: 10px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; margin-top: 4px; align-self: flex-start; }

        /* Chat Area (Right Side) */
        .chat-area {
            flex: 1; display: flex; flex-direction: column; background: #f2f2f2;
            position: relative; 
            /* Subtle Pattern Background */
            background-image: radial-gradient(#ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .chat-header {
            height: 64px; background: #fff; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10;
        }
        .ch-user-info h3 { margin: 0; font-size: 16px; color: var(--text-main); }
        .ch-user-info span { font-size: 12px; color: #27c93f; display: flex; align-items: center; gap: 4px; }
        
        .ch-controls { display: flex; gap: 8px; }
        .btn-action {
            background: #fff; border: 1px solid #ddd; padding: 6px 12px;
            border-radius: 6px; font-size: 13px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-action:hover { background: #f7f7f7; border-color: #ccc; }
        .btn-action.danger { color: #d32f2f; border-color: #ffcdd2; }
        .btn-action.danger:hover { background: #ffebee; }

        /* MESSAGES STYLING */
        .messages-container {
            flex: 1; padding: 20px 40px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 12px;
        }

        .msg-row { display: flex; width: 100%; margin-bottom: 4px; }
        .msg-row.admin { justify-content: flex-end; }
        .msg-row.user { justify-content: flex-start; }

        .bubble {
            max-width: 60%; padding: 10px 14px; 
            position: relative; font-size: 14.5px; line-height: 1.45;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }
        
        .bubble.user {
            background: var(--bubble-user);
            color: var(--text-main);
            border-radius: 0 12px 12px 12px;
        }
        /* Triangle for user */
        .bubble.user::before {
            content: ""; position: absolute; top: 0; left: -8px;
            width: 0; height: 0; 
            border-top: 10px solid var(--bubble-user);
            border-left: 10px solid transparent;
        }

        .bubble.admin {
            background: var(--primary); /* –ß–µ—Ä–≤–æ–Ω–∏–π */
            color: #fff;
            border-radius: 12px 0 12px 12px;
        }
        /* Triangle for admin */
        .bubble.admin::before {
            content: ""; position: absolute; top: 0; right: -8px;
            width: 0; height: 0; 
            border-top: 10px solid var(--primary);
            border-right: 10px solid transparent;
        }

        .msg-meta {
            display: block; font-size: 10px; margin-top: 4px; text-align: right; opacity: 0.8;
        }
        .msg-meta span { margin-left: 4px; font-weight: bold; }

        /* INPUT AREA */
        .input-area {
            padding: 15px 20px; background: #fff; border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: flex-end; position: relative;
        }
        
        /* Scripts Popup */
        .scripts-popup {
            position: absolute; bottom: 70px; left: 20px; width: 250px;
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none;
            max-height: 300px; overflow-y: auto; z-index: 20;
        }
        .script-option {
            padding: 10px 14px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 13px;
        }
        .script-option:hover { background: #f9f9f9; color: var(--primary); }
        .script-option strong { display: block; margin-bottom: 2px; color: #333; }
        .script-option span { font-size: 11px; color: #888; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn-icon {
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid #ddd;
            background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #555; transition: 0.2s; flex-shrink: 0;
        }
        .btn-icon:hover { background: #f0f0f0; color: var(--primary); }
        
        .chat-input {
            flex: 1; min-height: 42px; max-height: 120px; padding: 11px 16px;
            border: 1px solid #ddd; border-radius: 21px; background: #f9f9f9;
            font-size: 15px; resize: none; font-family: inherit; outline: none;
        }
        .chat-input:focus { background: #fff; border-color: var(--primary); }
        
        .btn-send {
            width: 42px; height: 42px; border-radius: 50%; background: var(--primary);
            color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; box-shadow: 0 2px 5px rgba(230,33,23,0.3);
        }
        .btn-send:hover { transform: scale(1.05); background: var(--primary-dark); }

        /* --- SETTINGS VIEW --- */
        .settings-view { padding: 40px; max-width: 900px; margin: 0 auto; overflow-y: auto; height: 100%; }
        .s-header { margin-bottom: 30px; }
        .s-card {
            background: #fff; border-radius: 12px; padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #eee;
        }
        .s-card h3 { margin: 0 0 20px 0; font-size: 18px; color: #333; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .inp { padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; }
        .inp:focus { border-color: var(--primary); }
        
        .btn-add {
            background: #111; color: #fff; padding: 10px 20px; border-radius: 8px; border: none;
            cursor: pointer; font-weight: 500; height: 100%;
        }
        .btn-add:hover { background: #333; }

        .list-items { display: flex; flex-direction: column; gap: 8px; }
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; background: #f9f9fb; border-radius: 8px; border: 1px solid #eee;
        }
        .row-info b { display: block; font-size: 14px; color: #333; margin-bottom: 2px; }
        .row-info span { display: block; font-size: 12px; color: #666; }
        .btn-del {
            background: #fff; border: 1px solid #ffcdd2; color: #d32f2f;
            width: 30px; height: 30px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-del:hover { background: #d32f2f; color: #fff; }

        /* LOGIN */
        .login-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 1000; display: flex; align-items: center; justify-content: center;
            background-image: radial-gradient(#e62117 1px, transparent 1px); background-size: 30px 30px;
        }
        .login-box {
            background: #fff; padding: 40px; border-radius: 16px; width: 340px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; border: 1px solid #eee;
        }
        .btn-login {
            width: 100%; background: var(--primary); color: #fff; padding: 12px;
            border-radius: 8px; border: none; font-size: 16px; margin-top: 15px; cursor: pointer;
        }

        /* MOBILE */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { 
                width: 100%; height: 60px; flex-direction: row; padding: 0 20px; 
                justify-content: space-around; order: 2; border-right: none; border-top: 1px solid #eee;
            }
            .logo { display: none; }
            .nav-item { margin: 0; }
            .main-content { order: 1; }
            .chat-list-panel { width: 100%; }
            .chat-area { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; 
                transform: translateX(100%); transition: transform 0.3s;
            }
            .chat-area.active { transform: translateX(0); }
            .mobile-back { display: block !important; margin-right: 10px; font-size: 20px; cursor: pointer; }
            .messages-container { padding: 15px; }
            .bubble { max-width: 75%; }
        }
        .mobile-back { display: none; }
        .empty-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ccc; }
    </style>
</head>
<body>

    <div class="login-wrap" id="login-screen">
        <div class="login-box">
            <h1 style="margin: 0 0 10px 0;">üå∂Ô∏è</h1>
            <h2 style="margin: 0 0 20px 0; color: #333;">Latiao Admin</h2>
            <input type="text" id="l-user" class="inp" placeholder="–õ–æ–≥—ñ–Ω" style="margin-bottom: 10px;">
            <input type="password" id="l-pass" class="inp" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-login" onclick="login()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="logo">üå∂Ô∏è</div>
            
            <div class="nav-item active" onclick="switchView('chats')" title="–ß–∞—Ç–∏">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                <div class="tooltip">–ß–∞—Ç–∏</div>
            </div>

            <div class="nav-item" id="nav-settings" onclick="switchView('settings')" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è" style="display:none;">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <div class="tooltip">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
            </div>

            <div class="nav-item" style="margin-top: auto;" onclick="logout()">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                <div class="tooltip">–í–∏—Ö—ñ–¥</div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="view-chats" class="view-section active chats-layout">
                <div class="chat-list-panel">
                    <div class="cl-header">
                        <h2 class="cl-title">–î—ñ–∞–ª–æ–≥–∏</h2>
                        <div class="cl-filters">
                            <div class="filter-btn active" onclick="setFilter('active', this)">–ê–∫—Ç–∏–≤–Ω—ñ</div>
                            <div class="filter-btn" onclick="setFilter('closed', this)">–ê—Ä—Ö—ñ–≤</div>
                        </div>
                    </div>
                    <div class="cl-items" id="chats-list">
                        </div>
                </div>

                <div class="chat-area" id="chat-window">
                    <div class="empty-placeholder" id="chat-empty">
                        <div style="font-size: 50px; opacity: 0.2; margin-bottom: 20px;">üí¨</div>
                        <p>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –¥–ª—è —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è</p>
                    </div>

                    <div id="chat-interface" style="display:none; flex-direction:column; height:100%;">
                        <div class="chat-header">
                            <div style="display: flex; align-items: center;">
                                <span class="mobile-back" onclick="closeChat()">‚Üê</span>
                                <div class="ch-user-info">
                                    <h3 id="current-user-id">User</h3>
                                    <span id="current-manager">–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ</span>
                                </div>
                            </div>
                            <div class="ch-controls">
                                <select id="mgr-select" class="btn-action" onchange="assignManager(this.value)">
                                    <option value="">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏...</option>
                                </select>
                                <button class="btn-action" onclick="askPhone()">üì± –ù–æ–º–µ—Ä</button>
                                <button class="btn-action danger" onclick="archiveChat()">–ê—Ä—Ö—ñ–≤</button>
                            </div>
                        </div>

                        <div class="messages-container" id="messages-feed"></div>

                        <form class="input-area" onsubmit="sendMessage(event)">
                            <div class="scripts-popup" id="scripts-pop"></div>
                            
                            <div class="btn-icon" onclick="toggleScripts()" title="–°–∫—Ä–∏–ø—Ç–∏">‚ö°</div>
                            <input type="text" id="msg-input" class="chat-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off">
                            <button type="submit" class="btn-send">‚û§</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="settings-view">
                    <div class="s-header">
                        <h1>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Workspace</h1>
                    </div>

                    <div class="s-card">
                        <h3>üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–∏</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1.5fr 0.5fr;">
                            <input id="m-name" class="inp" placeholder="–Ü–º'—è">
                            <input id="m-login" class="inp" placeholder="–õ–æ–≥—ñ–Ω">
                            <input id="m-pass" class="inp" placeholder="–ü–∞—Ä–æ–ª—å">
                            <input id="m-tg" class="inp" placeholder="Telegram Chat ID (—Ü–∏—Ñ—Ä–∏)">
                            <button class="btn-add" onclick="addManager()">+</button>
                        </div>
                        <div class="list-items" id="list-managers"></div>
                    </div>

                    <div class="s-card">
                        <h3>‚ö° –°–∫—Ä–∏–ø—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 2fr 0.5fr;">
                            <input id="s-title" class="inp" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è)">
                            <input id="s-text" class="inp" placeholder="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è">
                            <button class="btn-add" onclick="addScript()">+</button>
                        </div>
                        <div class="list-items" id="list-scripts"></div>
                    </div>

                    <div class="s-card">
                        <h3>‚ùì FAQ (–î–ª—è –≤—ñ–¥–∂–µ—Ç–∞)</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 2fr 0.5fr;">
                            <input id="f-q" class="inp" placeholder="–ü–∏—Ç–∞–Ω–Ω—è">
                            <input id="f-a" class="inp" placeholder="–í—ñ–¥–ø–æ–≤—ñ–¥—å">
                            <button class="btn-add" onclick="addFaq()">+</button>
                        </div>
                        <div class="list-items" id="list-faq"></div>
                    </div>
                    
                    <div class="s-card" style="display:flex; align-items:center; gap:15px;">
                        <input type="checkbox" id="w-status" onchange="toggleWidget(this.checked)" style="width:20px; height:20px;">
                        <label for="w-status" style="font-weight:600; font-size:16px;">–£–≤—ñ–º–∫–Ω—É—Ç–∏ —á–∞—Ç –Ω–∞ —Å–∞–π—Ç—ñ</label>
                    </div>

                </div>
            </div>

        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // --- SETUP ---
    const TG_TOKEN = "8538208852:AAFASKSeci30FVNU5sPl3vkmVSPLcfWFqEI";
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let currentChatId = null;
    let chatFilter = 'active';
    let msgListener = null;

    // --- AUTH ---
    function login() {
        const u = document.getElementById('l-user').value.trim();
        const p = document.getElementById('l-pass').value.trim();
        
        if(u==='admin' && p==='latiao2025') {
            authSuccess({name:'Admin', role:'admin', id:'root'});
            return;
        }

        db.ref('config/managers').once('value', s => {
            let found = false;
            s.forEach(c => {
                const m = c.val();
                if(m.login === u && m.pass === p) {
                    authSuccess({...m, id:c.key, role:'manager'});
                    found = true;
                }
            });
            if(!found) alert('–ù–µ–≤—ñ—Ä–Ω–æ!');
        });
    }

    function authSuccess(user) {
        currentUser = user;
        document.getElementById('login-screen').style.display = 'none';
        if(user.role === 'admin') {
            document.getElementById('nav-settings').style.display = 'flex';
            initSettings();
        }
        initChats();
    }
    
    function logout() { location.reload(); }

    // --- NAVIGATION ---
    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        if(view === 'chats') {
            document.getElementById('view-chats').classList.add('active');
            document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        } else {
            document.getElementById('view-settings').classList.add('active');
            document.querySelector('#nav-settings').classList.add('active');
        }
    }

    // --- CHAT LIST ---
    function setFilter(type, btn) {
        chatFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        initChats();
    }

    function initChats() {
        db.ref('active_chats').on('value', snap => {
            const list = document.getElementById('chats-list');
            list.innerHTML = '';
            const arr = [];
            snap.forEach(c => arr.push({id: c.key, ...c.val()}));
            arr.sort((a,b) => b.ts - a.ts);

            arr.forEach(chat => {
                if(chatFilter === 'active' && chat.status === 'closed') return;
                if(chatFilter === 'closed' && chat.status !== 'closed') return;

                const time = new Date(chat.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                const div = document.createElement('div');
                div.className = `c-item ${currentChatId === chat.id ? 'active' : ''}`;
                div.onclick = () => openChat(chat);
                
                div.innerHTML = `
                    <div class="c-avatar">${chat.id[0].toUpperCase()}</div>
                    <div class="c-info">
                        <div class="c-row">
                            <span class="c-name">–ö–ª—ñ—î–Ω—Ç ${chat.id.substring(0,4)}</span>
                            <span class="c-time">${time}</span>
                        </div>
                        <div class="c-msg">${chat.lastMsg || '...'}</div>
                        ${chat.managerName ? `<div class="c-manager">üë§ ${chat.managerName}</div>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    // --- CHAT WINDOW ---
    function openChat(chat) {
        currentChatId = chat.id;
        document.getElementById('chat-empty').style.display = 'none';
        document.getElementById('chat-interface').style.display = 'flex';
        document.getElementById('chat-window').classList.add('active'); // Mobile

        document.getElementById('current-user-id').innerText = `–ö–ª—ñ—î–Ω—Ç: ${chat.id}`;
        document.getElementById('current-manager').innerHTML = chat.managerName ? `–ú–µ–Ω–µ–¥–∂–µ—Ä: <b>${chat.managerName}</b>` : '–ú–µ–Ω–µ–¥–∂–µ—Ä: –ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ';

        // Auto assign if active and empty
        if(!chat.managerId && chatFilter === 'active') autoAssign(chat.id);

        // Load Messages
        if(msgListener) msgListener.off();
        const feed = document.getElementById('messages-feed');
        feed.innerHTML = '';

        msgListener = db.ref('support/' + chat.id);
        msgListener.on('value', snap => {
            feed.innerHTML = '';
            snap.forEach(c => renderMsg(c.val(), feed));
            feed.scrollTop = feed.scrollHeight;
        });

        loadManagersDropdown();
    }

    function renderMsg(m, container) {
        const row = document.createElement('div');
        row.className = `msg-row ${m.type}`;
        
        const time = new Date(m.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const check = (m.type === 'admin' && m.read) ? '<span style="color:#8dfcff;">‚úì‚úì</span>' : '<span>‚úì</span>';

        row.innerHTML = `
            <div class="bubble ${m.type}">
                ${m.text}
                <div class="msg-meta">${time} ${m.type==='admin' ? check : ''}</div>
            </div>
        `;
        container.appendChild(row);
    }

    function sendMessage(e) {
        e.preventDefault();
        const inp = document.getElementById('msg-input');
        const text = inp.value.trim();
        if(!text || !currentChatId) return;

        db.ref('support/' + currentChatId).push({ text, type: 'admin', ts: Date.now(), read: false });
        db.ref('active_chats/' + currentChatId).update({ lastMsg: '–í–∏: ' + text, ts: Date.now() });
        inp.value = '';
        document.getElementById('scripts-pop').style.display = 'none';
    }

    // --- ACTIONS ---
    function archiveChat() {
        if(confirm('–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –∞—Ä—Ö—ñ–≤?')) {
            db.ref('active_chats/'+currentChatId).update({status: 'closed'});
            closeChat();
        }
    }

    function askPhone() {
        const txt = "–ù–∞–ø–∏—à—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, –≤–∞—à –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É üìû";
        document.getElementById('msg-input').value = txt;
    }

    function closeChat() {
        document.getElementById('chat-window').classList.remove('active');
        setTimeout(() => {
            currentChatId = null;
            if(msgListener) msgListener.off();
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('chat-empty').style.display = 'flex';
        }, 300);
    }

    // --- MANAGERS LOGIC ---
    async function autoAssign(chatId) {
        const h = new Date().getHours();
        if(h >= 8) {
            const s = await db.ref('config/managers').once('value');
            const arr = [];
            s.forEach(x => arr.push({id:x.key, ...x.val()}));
            if(arr.length) {
                const rnd = arr[Math.floor(Math.random()*arr.length)];
                db.ref('active_chats/'+chatId).update({managerId:rnd.id, managerName:rnd.name});
            }
        }
    }

    function assignManager(mid) {
        if(!mid) return;
        db.ref('config/managers/'+mid).once('value', s => {
            const m = s.val();
            db.ref('active_chats/'+currentChatId).update({managerId:mid, managerName:m.name});
            alert('–ü–µ—Ä–µ–¥–∞–Ω–æ: ' + m.name);
            if(m.tgId) {
                fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: m.tgId, text: `üîÑ –í–∞–º –ø–µ—Ä–µ–¥–∞–Ω–æ —á–∞—Ç –∑ –∫–ª—ñ—î–Ω—Ç–æ–º!` })
                });
            }
        });
    }

    function loadManagersDropdown() {
        db.ref('config/managers').once('value', s => {
            const sel = document.getElementById('mgr-select');
            sel.innerHTML = '<option value="">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏...</option>';
            s.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.key;
                opt.innerText = c.val().name;
                sel.appendChild(opt);
            });
        });
    }

    // --- SCRIPTS LOGIC ---
    function toggleScripts() {
        const pop = document.getElementById('scripts-pop');
        if(pop.style.display === 'block') {
            pop.style.display = 'none';
            return;
        }
        
        pop.innerHTML = '<div style="padding:10px; color:#999;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        pop.style.display = 'block';

        db.ref('config/scripts').once('value', snap => {
            pop.innerHTML = '';
            if(!snap.exists()) {
                pop.innerHTML = '<div style="padding:10px;">–ü—É—Å—Ç–æ</div>';
                return;
            }
            snap.forEach(c => {
                const s = c.val();
                const d = document.createElement('div');
                d.className = 'script-option';
                d.innerHTML = `<strong>${s.title}</strong><span>${s.text}</span>`;
                d.onclick = () => {
                    document.getElementById('msg-input').value = s.text;
                    pop.style.display = 'none';
                    document.getElementById('msg-input').focus();
                };
                pop.appendChild(d);
            });
        });
    }

    // --- SETTINGS CRUD ---
    function initSettings() {
        // Managers
        db.ref('config/managers').on('value', s => renderList(s, 'list-managers', (d, k) => `
            <div class="row-info"><b>${d.name}</b><span>–õ–æ–≥—ñ–Ω: ${d.login} | TG: ${d.tgId || '-'}</span></div>
        `, 'config/managers'));
        
        // Scripts
        db.ref('config/scripts').on('value', s => renderList(s, 'list-scripts', (d, k) => `
            <div class="row-info"><b>${d.title}</b><span>${d.text}</span></div>
        `, 'config/scripts'));

        // FAQ
        db.ref('config/faq').on('value', s => renderList(s, 'list-faq', (d, k) => `
            <div class="row-info"><b>Q: ${d.q}</b><span>A: ${d.a}</span></div>
        `, 'config/faq'));

        db.ref('config/status').on('value', s => document.getElementById('w-status').checked = s.val() || false);
    }

    function renderList(snap, elId, htmlGen, refPath) {
        const el = document.getElementById(elId);
        el.innerHTML = '';
        snap.forEach(c => {
            const div = document.createElement('div');
            div.className = 'list-row';
            div.innerHTML = htmlGen(c.val(), c.key);
            const btn = document.createElement('div');
            btn.className = 'btn-del';
            btn.innerHTML = '‚úï';
            btn.onclick = () => { if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) db.ref(`${refPath}/${c.key}`).remove(); };
            div.appendChild(btn);
            el.appendChild(div);
        });
    }

    function addManager() {
        const n=id('m-name'), l=id('m-login'), p=id('m-pass'), t=id('m-tg');
        if(n.value && l.value) {
            db.ref('config/managers').push({name:n.value, login:l.value, pass:p.value, tgId:t.value});
            n.value=''; l.value=''; p.value=''; t.value='';
        }
    }
    function addScript() {
        const t=id('s-title'), x=id('s-text');
        if(t.value && x.value) {
            db.ref('config/scripts').push({title:t.value, text:x.value});
            t.value=''; x.value='';
        }
    }
    function addFaq() {
        const q=id('f-q'), a=id('f-a');
        if(q.value) {
            db.ref('config/faq').push({q:q.value, a:a.value});
            q.value=''; a.value='';
        }
    }
    function toggleWidget(v) { db.ref('config/status').set(v); }
    function id(x) { return document.getElementById(x); }

</script>
</body>
</html>
