<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latiao CRM v14.0 (Shake Analytics)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --primary: #e62117; 
            --green: #2ecc71;
            --orange: #f39c12;
            --red: #e74c3c;
            --purple: #9b59b6;
            --blue: #3498db;
            --teal: #1abc9c;

            /* THEME VARIABLES */
            --bg: #f4f7f6;
            --sidebar-bg: #fff;
            --card-bg: #fff;
            --border: #e1e4e8;
            --active-item: #fff5f5;
            --text-main: #2c3e50;
            --text-sec: #95a5a6;
            --input-bg: #f9f9f9;
            --input-border: #eee;
            --msg-user-bg: #fff;
            --msg-user-text: #2c3e50;
            --hover-btn: #f0f2f5;
            --shadow: rgba(0,0,0,0.08);
            --modal-overlay: rgba(0,0,0,0.5);
        }

        [data-theme="dark"] {
            --bg: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --border: #333;
            --active-item: #2c1b1b;
            --text-main: #e0e0e0;
            --text-sec: #a0a0a0;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --msg-user-bg: #2d2d2d;
            --msg-user-text: #e0e0e0;
            --hover-btn: #333;
            --shadow: rgba(0,0,0,0.5);
            --modal-overlay: rgba(0,0,0,0.7);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; height: 100vh; height: 100dvh; overflow: hidden;
            transition: background 0.3s;
        }

        /* --- APP CONTAINERS --- */
        #app-chat, #app-shake { display: none; width: 100%; height: 100%; }
        #app-chat.active, #app-shake.active { display: flex; }

        /* --- LOGIN SCREEN --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px var(--shadow); width: 320px; text-align: center; border: 1px solid var(--border); }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--input-border); border-radius: 12px; box-sizing: border-box; font-size: 16px; background: var(--input-bg); color: var(--text-main); }
        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .app-switcher { display: flex; background: var(--input-bg); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .app-switch-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s; }
        .app-switch-btn.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 5px var(--shadow); }

        /* --- SHARED LAYOUT STYLES --- */
        .sidebar { width: 360px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 2; transition: background 0.3s; }
        .sidebar-header { padding: 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info-box h2 { margin: 0; font-size: 22px; font-weight: 800; color: var(--text-main); }
        .typing-container { font-size: 13px; color: var(--primary); margin-top: 2px; font-weight: 600; display: flex; align-items: center; min-height: 20px; }
        .cursor { display: inline-block; width: 2px; height: 14px; background-color: var(--primary); margin-left: 2px; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 50%; border: 1px solid transparent; background: var(--hover-btn); color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { border-color: var(--border); transform: scale(1.05); }
        .logout-btn:hover { background: #ffebee; color: red; border-color: #ffcdd2; }
        .main { flex: 1; display: flex; flex-direction: column; background: var(--card-bg); position: relative; z-index: 1; }

        /* --- CHAT STYLES --- */
        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 35px 12px 14px; box-sizing: border-box; border: 1px solid var(--input-border); border-radius: 12px; background: var(--input-bg); color: var(--text-main); font-size: 15px; }
        .search-box span { position: absolute; right: 12px; top: 12px; color: var(--text-sec); }
        .filters { display: flex; gap: 5px; background: var(--hover-btn); padding: 4px; border-radius: 12px; }
        .filter-btn { flex: 1; background: none; border: none; padding: 8px; cursor: pointer; font-size: 13px; color: var(--text-sec); border-radius: 10px; font-weight: 600; transition: 0.2s; position: relative; }
        .filter-btn.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; display: none; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; background: var(--card-bg); transition: 0.2s; }
        .chat-item:hover { background: var(--hover-btn); }
        .chat-item.active { background: var(--active-item); border-left: 4px solid var(--primary); }
        .chat-item.unread strong { color: var(--primary); }
        .chat-item.closed { opacity: 0.6; filter: grayscale(0.8); }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .chat-id { font-weight: 700; font-size: 15px; color: var(--text-main); }
        .chat-time { font-size: 11px; color: var(--text-sec); }
        .chat-preview { font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
        .badges-row { display: flex; gap: 6px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; }
        .badge-new { background: var(--red); color: white; animation: pulse 2s infinite; }
        .badge-stale { background: var(--orange); color: white; }
        .assign-tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
        .assign-tag.user { background: rgba(52, 152, 219, 0.1); color: #3498db; border: 1px solid rgba(52, 152, 219, 0.2); }
        .assign-tag.none { background: rgba(243, 156, 18, 0.1); color: #f39c12; border: 1px solid rgba(243, 156, 18, 0.2); }
        .chat-header { height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--card-bg); flex-shrink: 0; }
        .back-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-main); padding-right: 15px; }
        .header-info h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text-main); }
        .manager-select { padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; background: var(--input-bg); color: var(--text-main); margin-top: 4px; }
        .header-right { display: flex; gap: 8px; align-items: center; }
        .status-toggle { display: flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .status-active { background: var(--green); color: white; }
        .status-closed { background: var(--hover-btn); color: var(--text-sec); border: 1px solid var(--border); }
        .btn-trash { background: none; border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 50%; color: var(--red); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-sms-toggle { background: rgba(52, 152, 219, 0.15); color: #3498db; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        #smsPanel { background: var(--active-item); border-bottom: 1px solid var(--primary); padding: 10px 20px; display: none; gap: 10px; align-items: center; animation: slideDown 0.3s ease; position: relative; }
        .sms-input { padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; width: 140px; background: var(--card-bg); color: var(--text-main); }
        .sms-select { padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; flex: 1; background: var(--card-bg); color: var(--text-main); }
        .btn-send-sms { background: var(--orange); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .sms-close { position: absolute; top:5px; right:5px; background:none; border:none; color: var(--text-sec); font-weight:bold; cursor:pointer;}
        .messages-area { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg); display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 18px; font-size: 15px; position: relative; display: flex; flex-direction: column; line-height: 1.4; box-shadow: 0 1px 2px var(--shadow); }
        .msg.user { align-self: flex-start; background: var(--msg-user-bg); border-bottom-left-radius: 4px; color: var(--msg-user-text); }
        .msg.admin { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg.log { align-self: center; background: rgba(243, 156, 18, 0.15); border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 12px; color: var(--text-main); font-size: 13px; max-width: 90%; text-align: center; box-shadow:none; }
        .msg-time { font-size: 10px; margin-top: 5px; align-self: flex-end; opacity: 0.7; }
        .msg-img { max-width: 100%; border-radius: 10px; cursor: pointer; margin-bottom: 5px; }
        .scripts-bar { display: flex; gap: 8px; padding: 10px 15px; background: var(--card-bg); border-top: 1px solid var(--border); overflow-x: auto; white-space: nowrap; }
        .script-chip { background: var(--hover-btn); color: var(--text-main); padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; border: 1px solid var(--border); font-weight: 500; transition: 0.2s; flex-shrink: 0; }
        .script-chip:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .input-area { padding: 10px 15px 15px 15px; display: flex; gap: 8px; background: var(--card-bg); padding-bottom: max(15px, env(safe-area-inset-bottom)); align-items: center; }
        .input-area input { flex: 1; padding: 12px 20px; border: 1px solid var(--input-border); border-radius: 25px; outline: none; font-size: 16px; background: var(--input-bg); color: var(--text-main); }
        .send-btn { background: var(--primary); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(230,33,23,0.3); }
        .media-btn { background: var(--hover-btn); color: var(--text-sec); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .media-btn:hover { background: var(--border); color: var(--text-main); }

        /* --- SHAKE ADMIN STYLES (NEW) --- */
        .shake-container { padding: 20px; overflow-y: auto; height: 100%; box-sizing: border-box; background: var(--bg); display: flex; flex-direction: column; }
        .shake-header { margin-bottom: 25px; }
        .shake-header h1 { margin: 0; color: var(--text-main); font-size: 26px; }
        .shake-header p { margin: 5px 0 0 0; color: var(--text-sec); font-size: 14px; }
        
        .section-title { font-size: 14px; font-weight: 700; color: var(--text-sec); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        
        .shake-stat-card {
            background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 4px 15px var(--shadow); position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between; height: 100px;
        }
        .shake-stat-card h3 { margin: 0; font-size: 14px; color: var(--text-sec); z-index: 1; }
        .shake-stat-value { font-size: 32px; font-weight: 800; color: var(--text-main); z-index: 1; margin-top: 5px; }
        .shake-stat-icon {
            position: absolute; right: 15px; top: 15px; font-size: 40px; opacity: 0.1;
            transform: rotate(-15deg); z-index: 0;
        }
        /* Card Colors */
        .card-purple { border-left: 4px solid var(--purple); }
        .card-purple .shake-stat-value { color: var(--purple); }
        .card-blue { border-left: 4px solid var(--blue); }
        .card-blue .shake-stat-value { color: var(--blue); }
        .card-green { border-left: 4px solid var(--green); }
        .card-green .shake-stat-value { color: var(--green); }
        .card-orange { border-left: 4px solid var(--orange); }
        .card-orange .shake-stat-value { color: var(--orange); }

        .shake-list-container { flex: 1; background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 12px var(--shadow); }
        .shake-tools { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; background: var(--card-bg); }
        .shake-list-scroll { flex: 1; overflow-y: auto; }
        
        .shake-row { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .shake-row:hover { background: var(--hover-btn); }
        .shake-info { display: flex; align-items: center; gap: 15px; }
        .shake-avatar { width: 45px; height: 45px; background: var(--hover-btn); color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; border: 1px solid var(--border); }
        .shake-details strong { display: block; font-size: 15px; color: var(--text-main); margin-bottom: 2px; }
        .shake-details span { font-size: 12px; color: var(--text-sec); display: block; }
        .shake-prize-badge { 
            font-weight: 700; color: var(--green); font-size: 13px; background: rgba(46, 204, 113, 0.1); 
            padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(46, 204, 113, 0.2); 
        }

        /* --- SETTINGS MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 600px; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: 1px solid var(--border); }
        .modal-tabs { display: flex; background: var(--card-bg); padding: 10px; border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sec); border-radius: 12px; min-width: 80px; transition: 0.2s; font-size: 13px; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(230,33,23,0.2); }
        .tab-content { padding: 20px; overflow-y: auto; display: none; flex: 1; }
        .tab-content.active { display: block; }
        .setting-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 15px; position: relative; box-shadow: 0 2px 8px var(--shadow); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-weight: 700; font-size: 13px; color: var(--text-main); text-transform: uppercase; }
        .btn-remove { color: var(--red); background: rgba(231, 76, 60, 0.1); border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sec); margin-bottom: 5px; text-transform: uppercase; }
        .styled-input, .styled-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); font-family: inherit; font-size: 14px; box-sizing: border-box; }
        .btn-add { width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--border); color: var(--text-sec); font-weight: 600; border-radius: 12px; cursor: pointer; margin-bottom: 20px; }
        .sticky-footer { padding: 15px; background: var(--card-bg); border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        .btn-save { flex: 2; padding: 12px; background: var(--text-main); color: var(--card-bg); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-close { flex: 1; padding: 12px; background: var(--hover-btn); color: var(--text-main); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
        .stat-num { font-size: 24px; font-weight: 800; display: block; color: var(--text-main); }
        .promo-stats-box { margin-top: 20px; background: var(--card-bg); border-radius: 16px; padding: 15px; border: 1px solid var(--border); }
        .promo-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .promo-count { font-weight: bold; color: var(--primary); }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .checkbox-wrapper input { width: 18px; height: 18px; accent-color: var(--primary); }
        .checkbox-wrapper span { font-size: 13px; color: var(--text-main); font-weight: 500; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100%; position: absolute; }
            .main, .shake-container { width: 100%; height: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s; }
            body.chat-open #app-chat .sidebar { transform: translateX(-20%); opacity: 0; pointer-events: none; } 
            body.chat-open #app-chat .main { transform: translateX(0); }
            /* Mobile Shake: Sidebar hidden, Main visible */
            #app-shake .main { transform: translateX(0); position: relative; }
            #app-shake .sidebar { width: 100%; transform: translateX(0); display:none; }
            
            .back-btn { display: block; }
            .chat-header { padding: 0 10px; }
            .status-toggle span#statusText { display: none; }
            .status-toggle { padding: 0; width: 38px; height: 38px; border-radius: 50%; justify-content: center; }
            #smsPanel { flex-direction: column; align-items: stretch; padding: 15px; }
            .sms-input { width: 100%; }
            .modal { align-items: flex-end; } 
            .modal-content { width: 100%; max-width: 100%; height: 85vh; border-radius: 24px 24px 0 0; margin: 0; }
            .modal-tabs { position: sticky; top: 0; z-index: 10; background: var(--card-bg); }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary)">Latiao CRM</h2>
        <div class="app-switcher">
            <button class="app-switch-btn active" id="modeChatBtn" onclick="selectLoginMode('chat')">üí¨ –ß–∞—Ç</button>
            <button class="app-switch-btn" id="modeShakeBtn" onclick="selectLoginMode('shake')">üì± Shake</button>
        </div>
        <p style="color:var(--text-sec); margin-bottom:15px; font-size:13px;" id="loginTitle">–í—Ö—ñ–¥ —É –ø—ñ–¥—Ç—Ä–∏–º–∫—É</p>
        <input type="text" id="loginUser" class="login-input" placeholder="–õ–æ–≥—ñ–Ω">
        <input type="password" id="loginPass" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="login-btn" onclick="authenticate()">–£–≤—ñ–π—Ç–∏</button>
    </div>
</div>

<div id="app-chat" class="app-module">
    
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('settings')">–ó–∞–≥–∞–ª—å–Ω—ñ</button>
                <button class="tab-btn" onclick="switchTab('promos')">–ü—Ä–æ–º–æ</button>
                <button class="tab-btn" onclick="switchTab('scripts')">–°–∫—Ä–∏–ø—Ç–∏</button>
                <button class="tab-btn" onclick="switchTab('faq')">FAQ</button>
                <button class="tab-btn" onclick="switchTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            </div>
            <div id="tab-settings" class="tab-content active">
                <h4 style="margin:0 0 15px 0; color:var(--text-main);">–ö–æ–º–∞–Ω–¥–∞</h4>
                <div id="managersList"></div>
                <button onclick="addManagerField()" class="btn-add">+ –î–æ–¥–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                <h4 style="margin:0 0 15px 0; color:var(--text-main);">–°–∏—Å—Ç–µ–º–∞</h4>
                <div class="setting-card">
                    <div class="input-group"><label>Telegram Bot Token</label><input type="text" id="tgTokenInput" class="styled-input"></div>
                    <div class="input-group"><label>Admin ID (Logs)</label><input type="text" id="adminIdInput" class="styled-input"></div>
                    <div class="input-group"><label>TurboSMS Token</label><input type="text" id="turboTokenInput" class="styled-input"></div>
                    <div class="input-group"><label>TurboSMS Sender</label><input type="text" id="turboSenderInput" class="styled-input"></div>
                </div>
            </div>
            <div id="tab-promos" class="tab-content">
                <div id="promosList"></div>
                <button onclick="addPromoField()" class="btn-add">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ–º–æ-–∫–æ–¥</button>
                <h4 style="margin:20px 0 10px 0; color:var(--text-main);">–¢–æ–ø –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫—ñ–≤</h4>
                <div class="promo-stats-box" id="promoStatsList"><p style="color:var(--text-sec);font-size:12px;text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p></div>
            </div>
            <div id="tab-scripts" class="tab-content"><div id="scriptsList"></div><button onclick="addScriptField()" class="btn-add">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–∫—Ä–∏–ø—Ç</button></div>
            <div id="tab-faq" class="tab-content"><div id="faqList"></div><button onclick="addFaqField()" class="btn-add">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button></div>
            <div id="tab-stats" class="tab-content">
                <div class="stat-grid">
                    <div class="stat-box"><span class="stat-num" id="statTotal">0</span><span style="font-size:11px; color:var(--text-sec);">–í–°–¨–û–ì–û</span></div>
                    <div class="stat-box"><span class="stat-num" style="color:var(--orange)" id="statActive">0</span><span style="font-size:11px; color:var(--text-sec);">–í –†–û–ë–û–¢–Ü</span></div>
                    <div class="stat-box"><span class="stat-num" style="color:var(--green)" id="statClosed">0</span><span style="font-size:11px; color:var(--text-sec);">–ó–ê–ö–†–ò–¢–Ü</span></div>
                </div>
                <div id="managerStatsList"></div>
            </div>
            <div class="sticky-footer">
                <button onclick="closeSettings()" class="btn-close">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="saveSettings()" class="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="top-row">
                <div class="user-info-box">
                    <h2>Latiao CRM</h2>
                    <div id="dynamicGreeting" class="typing-container"></div>
                </div>
                <div class="header-actions">
                    <button id="themeBtn" class="icon-btn" onclick="toggleTheme()">üåô</button>
                    <button id="btnSettings" class="icon-btn" onclick="openSettings()" style="display:none;">‚öôÔ∏è</button>
                    <button class="icon-btn logout-btn" onclick="logout()">üö™</button>
                </div>
            </div>
            <div class="search-box"><input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." onkeyup="renderChatList()"><span>üîç</span></div>
            <div class="filters">
                <button class="filter-btn active" id="btnOpen" onclick="setFilter('open')">–í—ñ–¥–∫—Ä–∏—Ç—ñ <span class="tab-badge" id="openCount"></span></button>
                <button class="filter-btn" id="btnClosed" onclick="setFilter('closed')">–ó–∞–∫—Ä–∏—Ç—ñ</button>
                <button class="filter-btn" id="btnAll" onclick="setFilter('all')">–í—Å—ñ</button>
            </div>
        </div>
        <div class="chat-list" id="chatList"></div>
    </div>

    <div class="main">
        <div class="chat-header" id="chatHeader">
            <div class="header-left">
                <button class="back-btn" onclick="closeChatMobile()">‚¨Ö</button>
                <div class="header-info"><h3 id="chatUserTitle">–ß–∞—Ç</h3><select id="managerSelect" class="manager-select" onchange="manualAssign(this.value)"><option value="">–ù–µ–º–∞—î</option></select></div>
            </div>
            <div class="header-right">
                <button class="btn-sms-toggle" onclick="toggleSmsPanel()">üéÅ SMS</button>
                <button id="statusBtn" class="status-toggle status-active" onclick="toggleChatStatus()"><span id="statusIcon">‚úì</span><span id="statusText">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</span></button>
                <button onclick="archiveChat()" class="btn-trash">üóë</button>
            </div>
        </div>
        <div id="smsPanel">
            <button class="sms-close" onclick="toggleSmsPanel()">‚úï</button>
            <input type="text" id="smsPhoneInput" class="sms-input" placeholder="380XXXXXXXXX">
            <select id="smsPromoSelect" class="sms-select"><option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–º–æ-–∫–æ–¥...</option></select>
            <button class="btn-send-sms" id="btnSendSms" onclick="sendTurboSMS()"><span id="smsBtnText">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</span></button>
        </div>
        <div class="messages-area" id="messagesArea">
            <div style="text-align:center; margin-top:50px; color:var(--text-sec);"><div style="font-size:40px; margin-bottom:10px;">üí¨</div>–û–±–µ—Ä—ñ—Ç—å –¥—ñ–∞–ª–æ–≥</div>
        </div>
        <div id="quickScripts" class="scripts-bar" style="display:none;"></div>
        <div class="input-area" id="inputArea">
            <input type="file" id="imgUpload" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
            <button class="media-btn" onclick="document.getElementById('imgUpload').click()">üìé</button>
            <input type="text" id="msgInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<div id="app-shake" class="app-module">
    
    <div id="shakeSettingsModal" class="modal">
        <div class="modal-content" style="height:auto;">
            <div style="padding:20px;border-bottom:1px solid var(--border);"><h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Shake</h3></div>
            <div style="padding:20px;">
                <p style="color:var(--text-sec)">–¢—É—Ç –≤–∏ –∑–º–æ–∂–µ—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø—Ä–∏–∑–∏, —à–∞–Ω—Å–∏ –≤–∏–ø–∞–¥–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≥—Ä–∏.</p>
                <div class="setting-card">
                    <div class="input-group"><label>–®–∞–Ω—Å –≤–∏–≥—Ä–∞—à—É (%)</label><input type="number" class="styled-input" value="30"></div>
                    <div class="input-group"><label>–ú–∞–∫—Å. —Å–ø—Ä–æ–± –Ω–∞ –¥–µ–Ω—å</label><input type="number" class="styled-input" value="3"></div>
                </div>
            </div>
            <div class="sticky-footer">
                <button onclick="document.getElementById('shakeSettingsModal').style.display='none'" class="btn-close">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="top-row">
                <div class="user-info-box">
                    <h2 style="color:var(--purple)">Shake Admin</h2>
                    <p style="font-size:12px;color:var(--text-sec);margin:0;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –≥—Ä–æ—é</p>
                </div>
                <div class="header-actions">
                    <button id="themeBtnShake" class="icon-btn" onclick="toggleTheme()">üåô</button>
                    <button class="icon-btn" onclick="document.getElementById('shakeSettingsModal').style.display='flex'">‚öôÔ∏è</button>
                    <button class="icon-btn logout-btn" onclick="logout()">üö™</button>
                </div>
            </div>
        </div>
        <div style="padding:20px; color:var(--text-sec); font-size:13px;">
            <p>–ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é –≥—Ä–∏ Shake. –¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤—Å—ñ —Å–ø—Ä–æ–±–∏, –≤–∏–≥—Ä–∞—à—ñ —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ª—É—á–µ–Ω–æ—Å—Ç—ñ.</p>
        </div>
    </div>

    <div class="main">
        <div class="shake-container">
            <div class="shake-header">
                <div>
                    <h1>–î–∞—à–±–æ—Ä–¥</h1>
                    <p>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</p>
                </div>
            </div>

            <div class="section-title">–°—å–æ–≥–æ–¥–Ω—ñ</div>
            <div class="dash-grid">
                <div class="shake-stat-card card-purple">
                    <h3>–¢—Ä—É—Å–∏–ª–∏ —Ä–∞–∑—ñ–≤</h3>
                    <div class="shake-stat-value" id="shakeShakesToday">0</div>
                    <div class="shake-stat-icon">üì±</div>
                </div>
                <div class="shake-stat-card card-green">
                    <h3>–í–∏–≥—Ä–∞–Ω–æ –ø—Ä–∏–∑—ñ–≤</h3>
                    <div class="shake-stat-value" id="shakeWinsToday">0</div>
                    <div class="shake-stat-icon">üéÅ</div>
                </div>
                <div class="shake-stat-card card-blue">
                    <h3>–í—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ</h3>
                    <div class="shake-stat-value" id="shakeVisitsToday">0</div>
                    <div class="shake-stat-icon">üë•</div>
                </div>
                <div class="shake-stat-card card-orange">
                    <h3>–ß–∞—Å —É –≥—Ä—ñ</h3>
                    <div class="shake-stat-value" id="shakeTimeToday">0m</div>
                    <div class="shake-stat-icon">‚è≥</div>
                </div>
            </div>

            <div class="section-title">–ó–∞ –≤–µ—Å—å —á–∞—Å</div>
            <div class="dash-grid">
                <div class="shake-stat-card">
                    <h3>–í—Å—å–æ–≥–æ —Å–ø—Ä–æ–±</h3>
                    <div class="shake-stat-value" id="shakeTotalShakes">0</div>
                </div>
                <div class="shake-stat-card">
                    <h3>–í—Å—å–æ–≥–æ –ø–µ—Ä–µ–º–æ–≥</h3>
                    <div class="shake-stat-value" id="shakeTotalWins">0</div>
                </div>
                <div class="shake-stat-card">
                    <h3>–í—Å—å–æ–≥–æ –≥–æ–¥–∏–Ω</h3>
                    <div class="shake-stat-value" id="shakeTotalTime">0h</div>
                </div>
            </div>

            <div class="shake-list-container">
                <div class="shake-tools">
                    <input type="text" id="shakeSearch" placeholder="–ü–æ—à—É–∫ –ø–µ—Ä–µ–º–æ–∂—Ü—è –∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º..." class="styled-input" onkeyup="renderShakeList()">
                </div>
                <div class="shake-list-scroll" id="shakeList">
                    <p style="text-align:center; color:var(--text-sec); padding:20px;">–î–∞–Ω—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // GLOBAL VARS
    let selectedMode = 'chat'; // 'chat' or 'shake'
    let allChats=[], managers=[], savedScripts=[], savedFaq=[], savedPromos=[], shakeLeads=[];
    let currentChatId=null, currentChatStatus='open', filterType='open';
    let tgBotToken="", superAdminId="", turboToken="", turboSender="";
    let currentUser=null; const SESSION_TIMEOUT = 24*60*60*1000;

    // STARTUP
    checkSession();

    function selectLoginMode(mode) {
        selectedMode = mode;
        document.querySelectorAll('.app-switch-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'chat') {
            document.getElementById('modeChatBtn').classList.add('active');
            document.getElementById('loginTitle').innerText = '–í—Ö—ñ–¥ —É –ø—ñ–¥—Ç—Ä–∏–º–∫—É';
        } else {
            document.getElementById('modeShakeBtn').classList.add('active');
            document.getElementById('loginTitle').innerText = '–í—Ö—ñ–¥ —É Shake Admin';
        }
    }

    function checkSession() {
        const storedUser = localStorage.getItem('lc_user');
        const loginTime = localStorage.getItem('lc_time');
        const savedMode = localStorage.getItem('lc_mode');

        if (storedUser && loginTime) {
            if (Date.now() - parseInt(loginTime) > SESSION_TIMEOUT) logout();
            else { 
                currentUser = JSON.parse(storedUser); 
                selectedMode = savedMode || 'chat'; // Restore mode
                initApp(); 
            }
        } else { document.getElementById('loginScreen').style.display = 'flex'; }
    }

    function authenticate() {
        const login = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        if(!login || !pass) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
        db.ref('config/managers').once('value', snap => {
            const mgrs = snap.val() || [];
            let found = mgrs.find(m => m.login === login && m.password === pass);
            if (!found && login === 'admin' && pass === 'admin' && mgrs.length === 0) {
                found = { name: 'Super Admin', id: 'root', role: 'admin', accessAnalytics: true };
            } else if (found && found.login === 'admin') {
                found.role = 'admin'; 
            }

            if (found) {
                currentUser = { ...found, role: found.role || 'manager' };
                localStorage.setItem('lc_user', JSON.stringify(currentUser));
                localStorage.setItem('lc_time', Date.now());
                localStorage.setItem('lc_mode', selectedMode); // Save selected mode
                initApp();
            } else { alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É'); }
        });
    }
    
    function logout() { 
        localStorage.removeItem('lc_user'); 
        localStorage.removeItem('lc_time'); 
        localStorage.removeItem('lc_mode');
        location.reload(); 
    }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        
        // Theme Load
        const savedTheme = localStorage.getItem('lc_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const icon = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        document.getElementById('themeBtn').innerText = icon;
        document.getElementById('themeBtnShake').innerText = icon;

        // HIDE ALL MODULES INITIALLY
        document.querySelectorAll('.app-module').forEach(el => el.classList.remove('active'));

        if (selectedMode === 'chat') {
            document.getElementById('app-chat').classList.add('active');
            initChatLogic();
        } else {
            document.getElementById('app-shake').classList.add('active');
            initShakeLogic();
        }
    }

    // --- CHAT LOGIC ---
    function initChatLogic() {
        startTyper(currentUser.name);
        
        if (currentUser.role === 'admin') {
            document.getElementById('btnSettings').style.display = 'flex';
        }
        loadSettings();
        
        db.ref('active_chats').on('value', snap => {
            allChats = [];
            snap.forEach(child => {
                const chatObj = { id: child.key, ...child.val() };
                // Assign Logic
                if (!chatObj.assignedTo && chatObj.status !== 'closed' && managers.length > 0) {
                    const isFaq = savedFaq.some(f => f.q === chatObj.lastMsg);
                    const isInvite = chatObj.lastMsg === "üó£ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞" || chatObj.lastMsg.toLowerCase().includes("–º–µ–Ω–µ–¥–∂–µ—Ä");
                    if (isInvite || (!isFaq && !chatObj.lastMsg.startsWith("Bot:"))) {
                        assignManager(managers[0].id, chatObj.id, "auto");
                        chatObj.assignedTo = managers[0].id;
                    }
                }
                allChats.push(chatObj);
            });
            allChats.sort((a, b) => b.ts - a.ts);
            renderChatList();
            if(currentChatId) {
                 const d = allChats.find(c => c.id === currentChatId);
                 if(d) {
                     document.getElementById('managerSelect').value = d.assignedTo || "";
                     currentChatStatus = d.status || 'open';
                     updateStatusButtonUI(currentChatStatus);
                 }
            }
        });
        setInterval(checkAutoReassignment, 30000);
    }

    // --- SHAKE LOGIC & ANALYTICS ---
    function initShakeLogic() {
        db.ref('shake_leads').on('value', snap => {
            shakeLeads = [];
            snap.forEach(child => shakeLeads.push({id: child.key, ...child.val()}));
            // Mock data if empty for visualization
            if (shakeLeads.length === 0) mockShakeData(); else shakeLeads.sort((a,b) => b.ts - a.ts);
            
            renderShakeView();
        });
    }

    function mockShakeData() {
        // Just for demo if no real data
        shakeLeads = [
            { id: '1', phone: '380991234567', prize: '–ó–Ω–∏–∂–∫–∞ -15%', code: 'SHAKE15', ts: Date.now() - 3600000 },
            { id: '2', phone: '380678889900', prize: '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞', code: 'FREESHIP', ts: Date.now() - 7200000 },
            { id: '3', phone: '380931112233', prize: '–°–µ–∫—Ä–µ—Ç–Ω–∏–π –°–Ω–µ–∫', code: 'BONUS', ts: Date.now() - 86400000 }
        ];
    }

    function renderShakeView() {
        const list = document.getElementById('shakeList');
        const search = document.getElementById('shakeSearch').value.toLowerCase();
        list.innerHTML = '';
        
        let totalWins = shakeLeads.length;
        let todayWins = 0;
        const now = new Date();
        
        const filtered = shakeLeads.filter(l => l.phone.includes(search));
        
        filtered.forEach(item => {
            if (new Date(item.ts).getDate() === now.getDate()) todayWins++;
            
            const time = new Date(item.ts).toLocaleString('uk-UA');
            const div = document.createElement('div');
            div.className = 'shake-row';
            div.innerHTML = `
                <div class="shake-info">
                    <div class="shake-avatar">üë§</div>
                    <div class="shake-details">
                        <strong>${item.phone}</strong>
                        <span>${time} | –ö–æ–¥: <b>${item.code}</b></span>
                    </div>
                </div>
                <div class="shake-prize-badge">${item.prize}</div>
            `;
            list.appendChild(div);
        });
        
        // --- CALCULATED MOCK METRICS (To make dashboard alive) ---
        // Assuming ~30% win rate for "Total Shakes"
        // Assuming ~2 min per session for "Time"
        
        const estTotalShakes = Math.floor(totalWins * 3.3) + 12; // Mock logic
        const estTodayShakes = Math.floor(todayWins * 3.5) + 4;  // Mock logic
        const estVisits = Math.floor(estTotalShakes * 1.5);
        const estTimeToday = Math.floor(estTodayShakes * 1.2); // Minutes
        const estTimeTotal = Math.floor(estTotalShakes * 1.2 / 60); // Hours

        // Update Dashboard with Animation
        animateValue("shakeShakesToday", 0, estTodayShakes, 1000);
        animateValue("shakeWinsToday", 0, todayWins, 1000);
        animateValue("shakeVisitsToday", 0, Math.floor(estTodayShakes * 1.4), 1000);
        document.getElementById("shakeTimeToday").innerText = estTimeToday + "m";

        animateValue("shakeTotalShakes", 0, estTotalShakes, 1500);
        animateValue("shakeTotalWins", 0, totalWins, 1500);
        document.getElementById("shakeTotalTime").innerText = estTimeTotal + "h";
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // --- COMMON HELPERS ---
    function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('lc_theme', next);
        const icon = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        document.getElementById('themeBtn').innerText = icon;
        document.getElementById('themeBtnShake').innerText = icon;
    }

    function startTyper(name) {
        const hour = new Date().getHours();
        let greeting = "–ü—Ä–∏–≤—ñ—Ç";
        if (hour >= 5 && hour < 11) greeting = "–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É";
        else if (hour >= 11 && hour < 18) greeting = "–î–æ–±—Ä–∏–π –¥–µ–Ω—å";
        else if (hour >= 18 && hour < 23) greeting = "–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä";
        else greeting = "–î–æ–±—Ä–æ—ó –Ω–æ—á—ñ";
        const text = `${greeting}, ${name}`;
        const container = document.getElementById('dynamicGreeting');
        if(!container) return; 
        container.innerHTML = '<span id="typeTarget"></span><span class="cursor"></span>';
        const target = document.getElementById('typeTarget');
        let i = 0; function type() { if (i < text.length) { target.innerHTML += text.charAt(i); i++; setTimeout(type, 80); } }
        type();
    }

    // --- CHAT RENDERERS (Standard) ---
    function renderChatList() {
        const container = document.getElementById('chatList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        container.innerHTML = '';
        let openUnreadCount = 0;
        const filtered = allChats.filter(chat => {
            const last = chat.lastMsg || "";
            const matchSearch = chat.id.toLowerCase().includes(search) || last.toLowerCase().includes(search);
            const status = chat.status || 'open';
            if (status === 'open' && chat.unread) openUnreadCount++;
            if (filterType === 'open') return matchSearch && status !== 'closed';
            if (filterType === 'closed') return matchSearch && status === 'closed';
            return matchSearch; 
        });
        const badge = document.getElementById('openCount');
        if (openUnreadCount > 0) { badge.innerText = openUnreadCount; badge.style.display = 'inline-block'; } else { badge.style.display = 'none'; }
        if (filtered.length === 0) { container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-sec);">–ü–æ—Ä–æ–∂–Ω—å–æ</div>'; return; }
        filtered.forEach(chat => {
            const div = document.createElement('div');
            const time = new Date(chat.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isClosed = chat.status === 'closed';
            const last = chat.lastMsg || "...";
            const isUserLast = !last.startsWith("–í–∏:") && !last.startsWith("üëã") && !last.startsWith("Bot:") && !last.startsWith("üéÅ");
            const timeDiff = Date.now() - chat.ts;
            const isStale = !isClosed && isUserLast && timeDiff > 5 * 60 * 1000;
            let badgesHtml = '';
            if (chat.assignedTo) {
                const mgr = managers.find(m => m.id == chat.assignedTo); const mgrName = mgr ? mgr.name : "Unknown";
                badgesHtml += `<span class="assign-tag user">üë§ ${mgrName}</span>`;
            } else if (!isClosed) { badgesHtml += `<span class="assign-tag none">‚ö†Ô∏è –ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ</span>`; }
            if (chat.unread) badgesHtml += `<span class="badge badge-new">NEW</span>`;
            if (isStale) badgesHtml += `<span class="badge badge-stale">‚è≥ –ß–µ–∫–∞—î</span>`;
            div.className = `chat-item ${currentChatId === chat.id ? 'active' : ''} ${chat.unread ? 'unread' : ''} ${isClosed ? 'closed' : ''}`;
            div.onclick = () => openChat(chat.id);
            div.innerHTML = `<div class="chat-top"><span class="chat-id">#${chat.id.substring(0,6)}</span><span class="chat-time">${time}</span></div><div class="chat-preview">${last}</div><div class="badges-row">${badgesHtml}</div>`;
            container.appendChild(div);
        });
    }

    function setFilter(type) { filterType = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active'); renderChatList(); }

    function openChat(chatId) {
        currentChatId = chatId; renderChatList(); document.body.classList.add('chat-open');
        const chatData = allChats.find(c => c.id === chatId);
        const status = chatData ? (chatData.status || 'open') : 'open';
        currentChatStatus = status;
        document.getElementById('chatUserTitle').innerText = '–ö–ª—ñ—î–Ω—Ç #' + chatId.substring(0,6);
        if (/^\d{10,12}$/.test(chatId)) document.getElementById('smsPhoneInput').value = chatId; else document.getElementById('smsPhoneInput').value = "";
        document.getElementById('smsPanel').style.display = 'none';
        updateManagerDropdown(chatData ? chatData.assignedTo : "");
        updateStatusButtonUI(status);
        db.ref('active_chats/' + chatId).update({ unread: false });
        const area = document.getElementById('messagesArea');
        area.innerHTML = '<div style="text-align:center; padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        if (msgsListener) msgsListener.off();
        msgsListener = db.ref('support/' + chatId);
        msgsListener.on('value', snap => {
            area.innerHTML = '';
            snap.forEach(child => { renderMessage(child.val(), area); });
            area.scrollTop = area.scrollHeight;
        });
        renderQuickScripts();
    }

    function toggleSmsPanel() { const p = document.getElementById('smsPanel'); p.style.display = p.style.display === 'none' ? 'flex' : 'none'; const sel = document.getElementById('smsPromoSelect'); sel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–º–æ-–∫–æ–¥...</option>'; savedPromos.forEach(pr => { const opt = document.createElement('option'); opt.value = pr.text; opt.innerText = pr.title; sel.appendChild(opt); }); }
    function sendTurboSMS() {
        if (!turboToken) return alert("–ù–∞–ª–∞—à—Ç—É–π—Ç–µ TurboSMS!");
        const phone = document.getElementById('smsPhoneInput').value.trim(); const text = document.getElementById('smsPromoSelect').value; const sender = turboSender || "Msg";
        if (!phone || !text) return alert("–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ");
        const btn = document.getElementById('btnSendSms'); const btnText = document.getElementById('smsBtnText'); const originalText = btnText.innerText; btnText.innerText = "–í—ñ–¥–ø—Ä–∞–≤–∫–∞..."; btn.disabled = true;
        fetch("https://api.turbosms.ua/message/send.json", { method: "POST", headers: { "Authorization": `Bearer ${turboToken}`, "Content-Type": "application/json" }, body: JSON.stringify({ recipients: [phone], sms: { sender: sender, text: text } }) })
        .then(res => res.json()).then(data => {
            btn.disabled = false; btnText.innerText = originalText;
            if (data.response_code === 0 || data.response_code === 800 || (data.response_status && data.response_status.includes("SUCCESS"))) {
                alert("SMS –ù–∞–¥—ñ—Å–ª–∞–Ω–æ!");
                db.ref('support/' + currentChatId).push({ text: `üéÅ SMS –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ ${phone}: ${text}`, type: 'admin', msgType: 'log', ts: Date.now() });
                const statKey = currentUser.login || "unknown";
                db.ref('config/stats/promos/' + statKey).transaction(count => (count || 0) + 1);
                toggleSmsPanel();
            } else { alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: " + (data.response_status || "–ù–µ–≤—ñ–¥–æ–º–æ")); }
        }).catch(err => { btn.disabled = false; btnText.innerText = originalText; alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ"); });
    }

    function handleImageUpload(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.src = e.target.result; img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 800; let width = img.width; let height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); sendMessage(dataUrl, 'image'); } }; reader.readAsDataURL(file); } }
    function renderQuickScripts() { const bar = document.getElementById('quickScripts'); if (savedScripts.length === 0) { bar.style.display = 'none'; return; } bar.style.display = 'flex'; bar.innerHTML = ''; savedScripts.forEach(s => { const chip = document.createElement('div'); chip.className = 'script-chip'; chip.innerText = s.title; chip.onclick = () => useScript(s.text); bar.appendChild(chip); }); }
    function useScript(text) { document.getElementById('msgInput').value = text; document.getElementById('msgInput').focus(); }
    function closeChatMobile() { document.body.classList.remove('chat-open'); }
    function renderMessage(msg, container) { const div = document.createElement('div'); if (msg.msgType === 'log') { div.className = 'msg log'; div.innerText = msg.text; } else { div.className = `msg ${msg.type === 'admin' ? 'admin' : 'user'}`; let timeStr = ""; if (msg.ts) timeStr = new Date(msg.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); let content = ""; if (msg.msgType === 'image') content = `<img src="${msg.text}" class="msg-img" onclick="window.open(this.src)">`; else content = `<span>${msg.text}</span>`; div.innerHTML = `${content}<span class="msg-time">${timeStr}</span>`; } container.appendChild(div); }
    function updateStatusButtonUI(status) { const btn = document.getElementById('statusBtn'); const icon = document.getElementById('statusIcon'); const text = document.getElementById('statusText'); if (status === 'closed') { btn.className = 'status-toggle status-closed'; icon.innerText = '‚Ü∫'; text.innerText = '–í—ñ–¥–Ω–æ–≤–∏—Ç–∏'; } else { btn.className = 'status-toggle status-active'; icon.innerText = '‚úì'; text.innerText = '–ó–∞–≤–µ—Ä—à–∏—Ç–∏'; } }
    function toggleChatStatus() { if(!currentChatId) return; const newStatus = currentChatStatus === 'open' ? 'closed' : 'open'; db.ref('active_chats/' + currentChatId).update({ status: newStatus }); currentChatStatus = newStatus; updateStatusButtonUI(newStatus); }
    function updateManagerDropdown(assignedId) { const select = document.getElementById('managerSelect'); select.innerHTML = '<option value="">–ù–µ–º–∞—î</option>'; managers.forEach(mgr => { const opt = document.createElement('option'); opt.value = mgr.id; opt.innerText = mgr.name; select.appendChild(opt); }); select.value = assignedId || ""; }
    function manualAssign(val) { assignManager(val, currentChatId, "manual"); }
    function assignManager(managerId, chatId, reason = "manual") { if(!chatId) return; db.ref('active_chats/' + chatId).update({ assignedTo: managerId }); const mgr = managers.find(m => m.id == managerId); if (mgr) { const systemMsg = `üëã –ú–µ–Ω–µ–¥–∂–µ—Ä ${mgr.name} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ —á–∞—Ç—É —ñ –≤–∂–µ –æ–∑–Ω–∞–π–æ–º–ª—é—î—Ç—å—Å—è –∑ –≤–∞—à–∏–º –ø–∏—Ç–∞–Ω–Ω—è–º.`; db.ref('support/' + chatId).limitToLast(1).once('value', snap => { let lastMsg = null; snap.forEach(c => lastMsg = c.val()); if (!lastMsg || lastMsg.text !== systemMsg) { db.ref('support/' + chatId).push({ text: systemMsg, type: 'admin', ts: Date.now() }); } }); } if (tgBotToken) { const managerName = mgr ? mgr.name : "–ù–µ–≤—ñ–¥–æ–º–∏–π"; if (managerId && mgr) { let text = ""; if (reason === "manual") text = `üîî *–í–ê–ú –ü–†–ò–ó–ù–ê–ß–ï–ù–û –ß–ê–¢*\nID: \`${chatId}\``; else if (reason === "timeout") text = `üö® *–ü–ï–†–ï–î–ê–ß–ê –ß–ê–¢–£*\nID: \`${chatId}\`\n(–¢–∞–π–º–∞—É—Ç)`; else if (reason === "auto") text = `‚ö° *–ù–û–í–ò–ô –ß–ê–¢*\nID: \`${chatId}\``; sendTelegram(managerId, text); } if (superAdminId && superAdminId !== managerId) { sendTelegram(superAdminId, `üëÆ‚Äç‚ôÇÔ∏è *LOG* | ${managerName} | ${reason}\nID: \`${chatId}\``); } } }
    function sendTelegram(chatId, text) { fetch(`https://api.telegram.org/bot${tgBotToken}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'Markdown' }) }).catch(console.error); }
    function checkAutoReassignment() { if (managers.length === 0) return; const NOW = Date.now(); const TIMEOUT = 5 * 60 * 1000; allChats.forEach(chat => { if (chat.unread === true && chat.status !== 'closed') { const timeDiff = NOW - chat.ts; if (timeDiff > TIMEOUT) { if (chat.assignedTo) { const currentIndex = managers.findIndex(m => m.id == chat.assignedTo); let nextIndex = currentIndex + 1; if (nextIndex >= managers.length) nextIndex = 0; if (managers.length > 1 || (managers.length === 1 && currentIndex === -1)) { const nextManagerId = managers[nextIndex].id; if (nextManagerId !== chat.assignedTo) assignManager(nextManagerId, chat.id, "timeout"); } } else { assignManager(managers[0].id, chat.id, "auto"); } } } }); }
    function sendMessage(text = null, type = 'text') { const input = document.getElementById('msgInput'); const val = text || input.value.trim(); if (!val || !currentChatId) return; const ts = Date.now(); db.ref('support/' + currentChatId).push({ text: val, type: 'admin', msgType: type, ts }); db.ref('active_chats/' + currentChatId).update({ lastMsg: (type === 'text' ? '–í–∏: ' + val : 'üì∑ –§–æ—Ç–æ'), ts, unread: false, status: 'open' }); input.value = ''; }
    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
    function archiveChat() { if (!currentChatId) return; if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–∑–∞–≤–∂–¥–∏?')) { db.ref('active_chats/' + currentChatId).remove(); if(document.body.classList.contains('chat-open')) closeChatMobile(); } }

    function openSettings() { if(currentUser.role !== 'admin') return; document.getElementById('settingsModal').style.display = 'flex'; renderAllInputs(); switchTab('settings'); }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function switchTab(tabName) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); if (tabName === 'settings') { document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.getElementById('tab-settings').classList.add('active'); } else if (tabName === 'promos') { document.querySelectorAll('.tab-btn')[1].classList.add('active'); document.getElementById('tab-promos').classList.add('active'); loadPromoStats(); } else if (tabName === 'scripts') { document.querySelectorAll('.tab-btn')[2].classList.add('active'); document.getElementById('tab-scripts').classList.add('active'); } else if (tabName === 'faq') { document.querySelectorAll('.tab-btn')[3].classList.add('active'); document.getElementById('tab-faq').classList.add('active'); } else { document.querySelectorAll('.tab-btn')[4].classList.add('active'); document.getElementById('tab-stats').classList.add('active'); calculateStats(); } }
    function calculateStats() { let total = 0, active = 0, closed = 0; let mgrStats = {}; managers.forEach(m => { mgrStats[m.id] = { name: m.name, active: 0, closed: 0 }; }); allChats.forEach(chat => { total++; const isClosed = chat.status === 'closed'; if (isClosed) closed++; else active++; if (chat.assignedTo && mgrStats[chat.assignedTo]) { if (isClosed) mgrStats[chat.assignedTo].closed++; else mgrStats[chat.assignedTo].active++; } }); document.getElementById('statTotal').innerText = total; document.getElementById('statActive').innerText = active; document.getElementById('statClosed').innerText = closed; const list = document.getElementById('managerStatsList'); list.innerHTML = ''; Object.keys(mgrStats).forEach(id => { const m = mgrStats[id]; const div = document.createElement('div'); div.className = 'stat-item'; div.innerHTML = `<span style="font-weight:600">${m.name}</span><div style="font-size:12px"><span style="color:#e67e22;font-weight:bold;margin-right:10px;">‚ö° ${m.active}</span><span style="color:#2ecc71;font-weight:bold;">‚úì ${m.closed}</span></div>`; div.style.padding = "10px 0"; div.style.borderBottom = "1px solid var(--border)"; div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.color = "var(--text-main)"; list.appendChild(div); }); }
    function loadPromoStats() { const list = document.getElementById('promoStatsList'); list.innerHTML = '<p style="color:var(--text-sec); font-size:12px; text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>'; db.ref('config/stats/promos').once('value', snap => { const stats = snap.val() || {}; list.innerHTML = ''; if (Object.keys(stats).length === 0) { list.innerHTML = '<p style="color:var(--text-sec); font-size:12px; text-align:center;">–ü–æ–∫–∏ –Ω—ñ—Ö—Ç–æ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–≤</p>'; return; } let sorted = []; Object.keys(stats).forEach(key => { let mgr = managers.find(m => m.login === key); if (!mgr) mgr = managers.find(m => m.id === key); const name = mgr ? mgr.name : "–ù–µ–≤—ñ–¥–æ–º–∏–π (" + key + ")"; sorted.push({ name: name, count: stats[key] }); }); sorted.sort((a,b) => b.count - a.count); sorted.forEach(item => { const div = document.createElement('div'); div.className = 'promo-row'; div.innerHTML = `<span>${item.name}</span><span class="promo-count">${item.count} —à—Ç.</span>`; list.appendChild(div); }); }); }
    function renderAllInputs() { const mList = document.getElementById('managersList'); mList.innerHTML = ''; document.getElementById('tgTokenInput').value = tgBotToken; document.getElementById('adminIdInput').value = superAdminId; document.getElementById('turboTokenInput').value = turboToken; document.getElementById('turboSenderInput').value = turboSender; managers.forEach((m, i) => addManagerField(m.name, m.id, m.login, m.password, i)); const pList = document.getElementById('promosList'); pList.innerHTML = ''; savedPromos.forEach((p, i) => addPromoField(p.title, p.text, i)); const sList = document.getElementById('scriptsList'); sList.innerHTML = ''; savedScripts.forEach((s, i) => addScriptField(s.title, s.text, i)); const fList = document.getElementById('faqList'); fList.innerHTML = ''; savedFaq.forEach((f, i) => addFaqField(f.q, f.a, i)); }
    function addManagerField(name='', id='', login='', pass='', index=Date.now()) { const div = document.createElement('div'); div.className = 'setting-card'; div.innerHTML = `<div class="card-header"><span class="card-title">–ú–µ–Ω–µ–¥–∂–µ—Ä</span><button onclick="this.parentElement.parentElement.remove()" class="btn-remove">‚úï</button></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><div class="input-group"><label>–Ü–º'—è</label><input type="text" class="styled-input mgr-name" value="${name}"></div><div class="input-group"><label>Telegram ID</label><input type="text" class="styled-input mgr-id" value="${id}"></div><div class="input-group"><label>–õ–æ–≥—ñ–Ω</label><input type="text" class="styled-input mgr-login" value="${login}"></div><div class="input-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="text" class="styled-input mgr-pass" value="${pass}"></div></div>`; document.getElementById('managersList').appendChild(div); }
    function addPromoField(title='', text='', index=Date.now()) { const div = document.createElement('div'); div.className = 'setting-card'; div.innerHTML = `<div class="card-header"><span class="card-title">–ü—Ä–æ–º–æ-–∫–æ–¥</span><button onclick="this.parentElement.parentElement.remove()" class="btn-remove">‚úï</button></div><div class="input-group"><label>–ù–∞–∑–≤–∞ (–¥–ª—è —Å–ø–∏—Å–∫—É)</label><input type="text" class="styled-input promo-title" value="${title}" placeholder="–ó–Ω–∏–∂–∫–∞ 10%"></div><div class="input-group"><label>–¢–µ–∫—Å—Ç SMS</label><textarea class="styled-textarea promo-text" placeholder="–í–∞—à –∫–æ–¥: SALE10">${text}</textarea></div>`; document.getElementById('promosList').appendChild(div); }
    function addScriptField(title='', text='', index=Date.now()) { const div = document.createElement('div'); div.className = 'setting-card'; div.innerHTML = `<div class="card-header"><span class="card-title">–°–∫—Ä–∏–ø—Ç</span><button onclick="this.parentElement.parentElement.remove()" class="btn-remove">‚úï</button></div><div class="input-group"><label>–ù–∞–∑–≤–∞ –∫–Ω–æ–ø–∫–∏</label><input type="text" class="styled-input script-title" value="${title}" placeholder="–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"></div><div class="input-group"><label>–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</label><textarea class="styled-textarea script-text" placeholder="–î–æ–±—Ä–æ–≥–æ –¥–Ω—è...">${text}</textarea></div>`; document.getElementById('scriptsList').appendChild(div); }
    function addFaqField(q='', a='', index=Date.now()) { const div = document.createElement('div'); div.className = 'setting-card'; div.innerHTML = `<div class="card-header"><span class="card-title">–ü–∏—Ç–∞–Ω–Ω—è FAQ</span><button onclick="this.parentElement.parentElement.remove()" class="btn-remove">‚úï</button></div><div class="input-group"><label>–ü–∏—Ç–∞–Ω–Ω—è</label><input type="text" class="styled-input faq-q" value="${q}"></div><div class="input-group"><label>–í—ñ–¥–ø–æ–≤—ñ–¥—å</label><textarea class="styled-textarea faq-a">${a}</textarea></div>`; document.getElementById('faqList').appendChild(div); }
    function saveSettings() { const newManagers = []; document.querySelectorAll('.mgr-name').forEach((el) => { const row = el.closest('.setting-card'); const name = row.querySelector('.mgr-name').value.trim(); const id = row.querySelector('.mgr-id').value.trim(); const login = row.querySelector('.mgr-login').value.trim(); const pass = row.querySelector('.mgr-pass').value.trim(); if (name && id && login && pass) newManagers.push({ name, id, login, password: pass }); }); const newPromos = []; document.querySelectorAll('.promo-title').forEach((el) => { const row = el.closest('.setting-card'); const title = row.querySelector('.promo-title').value.trim(); const text = row.querySelector('.promo-text').value.trim(); if (title && text) newPromos.push({ title, text }); }); const newScripts = []; document.querySelectorAll('.script-title').forEach((el) => { const row = el.closest('.setting-card'); const title = row.querySelector('.script-title').value.trim(); const text = row.querySelector('.script-text').value.trim(); if (title && text) newScripts.push({ title, text }); }); const newFaq = []; document.querySelectorAll('.faq-q').forEach((el) => { const row = el.closest('.setting-card'); const q = row.querySelector('.faq-q').value.trim(); const a = row.querySelector('.faq-a').value.trim(); if (q && a) newFaq.push({ q, a }); }); const token = document.getElementById('tgTokenInput').value.trim(); const adminId = document.getElementById('adminIdInput').value.trim(); const tbToken = document.getElementById('turboTokenInput').value.trim(); const tbSender = document.getElementById('turboSenderInput').value.trim(); db.ref('config').update({ managers: newManagers, promos: newPromos, scripts: newScripts, faq: newFaq, tg_token: token, admin_id: adminId, turbo_token: tbToken, turbo_sender: tbSender }); managers = newManagers; savedPromos = newPromos; savedScripts = newScripts; savedFaq = newFaq; tgBotToken = token; superAdminId = adminId; turboToken = tbToken; turboSender = tbSender; if(currentChatId) renderQuickScripts(); closeSettings(); alert('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!'); }
    function loadSettings() { db.ref('config').once('value', snap => { const cfg = snap.val() || {}; managers = cfg.managers || []; savedPromos = cfg.promos || []; savedScripts = cfg.scripts || []; savedFaq = cfg.faq || []; tgBotToken = cfg.tg_token || ""; superAdminId = cfg.admin_id || ""; turboToken = cfg.turbo_token || ""; turboSender = cfg.turbo_sender || ""; if(currentChatId) renderQuickScripts(); }); }
</script>

</body>
</html>
