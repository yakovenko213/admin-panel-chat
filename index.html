<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latiao CRM v15.5 (Unified)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            /* BRAND & THEME COLORS */
            --primary: #e62117; 
            --green: #2ecc71; --orange: #f39c12; --red: #e74c3c;
            --purple: #9b59b6; --blue: #3498db;

            --bg: #f4f7f6; --sidebar-bg: #fff; --card-bg: #fff;
            --border: #e1e4e8; --active-item: #fff5f5; --text-main: #2c3e50;
            --text-sec: #95a5a6; --input-bg: #f9f9f9; --input-border: #eee;
            --msg-user-bg: #fff; --msg-user-text: #2c3e50; --hover-btn: #f0f2f5;
            --shadow: rgba(0,0,0,0.08); --modal-overlay: rgba(0,0,0,0.5);
        }

        [data-theme="dark"] {
            --bg: #121212; --sidebar-bg: #1e1e1e; --card-bg: #1e1e1e;
            --border: #333; --active-item: #2c1b1b; --text-main: #e0e0e0;
            --text-sec: #a0a0a0; --input-bg: #2d2d2d; --input-border: #444;
            --msg-user-bg: #2d2d2d; --msg-user-text: #e0e0e0; --hover-btn: #333;
            --shadow: rgba(0,0,0,0.5); --modal-overlay: rgba(0,0,0,0.7);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; height: 100vh; height: 100dvh; overflow: hidden;
            transition: background 0.3s;
        }

        /* --- APP STRUCTURE --- */
        .app-module { display: none; width: 100%; height: 100%; display: flex; } /* Flex is default, toggle visibility via JS */
        .app-module:not(.active) { display: none; }

        /* --- LOGIN --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px var(--shadow); width: 320px; text-align: center; border: 1px solid var(--border); }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--input-border); border-radius: 12px; box-sizing: border-box; font-size: 16px; background: var(--input-bg); color: var(--text-main); }
        .login-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .app-switcher { display: flex; background: var(--input-bg); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .app-switch-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s; }
        .app-switch-btn.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 5px var(--shadow); }

        /* --- SHARED LAYOUT (SIDEBAR & MAIN) --- */
        .sidebar { width: 360px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 2; transition: background 0.3s; }
        .sidebar-header { padding: 15px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-info-box h2 { margin: 0; font-size: 22px; font-weight: 800; color: var(--text-main); }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 50%; border: 1px solid transparent; background: var(--hover-btn); color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { border-color: var(--border); transform: scale(1.05); }
        .logout-btn:hover { background: #ffebee; color: red; border-color: #ffcdd2; }

        .search-box { position: relative; margin-bottom: 10px; }
        .search-box input { width: 100%; padding: 12px 35px 12px 14px; box-sizing: border-box; border: 1px solid var(--input-border); border-radius: 12px; background: var(--input-bg); color: var(--text-main); font-size: 15px; }
        .search-box span { position: absolute; right: 12px; top: 12px; color: var(--text-sec); }
        
        .list-container { flex: 1; overflow-y: auto; }
        .list-item { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; background: var(--card-bg); transition: 0.2s; }
        .list-item:hover { background: var(--hover-btn); }
        .list-item.active { background: var(--active-item); border-left: 4px solid var(--primary); }
        .list-top { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .list-title { font-weight: 700; font-size: 15px; color: var(--text-main); }
        .list-time { font-size: 11px; color: var(--text-sec); }
        .list-desc { font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
        
        .main { flex: 1; display: flex; flex-direction: column; background: var(--card-bg); position: relative; z-index: 1; }
        .main-header { height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--card-bg); flex-shrink: 0; }
        .main-title h3 { margin: 0; font-size: 16px; font-weight: 700; color: var(--text-main); }
        .back-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-main); padding-right: 15px; }

        .content-area { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg); display: flex; flex-direction: column; gap: 10px; }
        
        /* CHAT BUBBLES / HISTORY ITEMS */
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; position: relative; display: flex; flex-direction: column; line-height: 1.4; box-shadow: 0 1px 2px var(--shadow); align-self: flex-start; }
        .bubble.user { background: var(--msg-user-bg); border-bottom-left-radius: 4px; color: var(--msg-user-text); }
        .bubble.admin { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .bubble.system { align-self: center; background: rgba(52, 152, 219, 0.1); color: var(--text-main); border: 1px solid rgba(52, 152, 219, 0.2); text-align: center; max-width: 90%; }
        .bubble-time { font-size: 10px; margin-top: 5px; align-self: flex-end; opacity: 0.7; }

        /* DASHBOARD IN MAIN AREA (FOR SHAKE) */
        .dashboard-view { padding: 20px; display: flex; flex-direction: column; gap: 20px; text-align: center; }
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .dash-card { background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 2px 8px var(--shadow); }
        .dash-card h3 { margin: 0 0 5px 0; font-size: 12px; text-transform: uppercase; color: var(--text-sec); }
        .dash-value { font-size: 24px; font-weight: 800; color: var(--text-main); }

        /* INPUT AREA (CHAT ONLY) */
        .input-area { padding: 10px 15px 15px 15px; display: flex; gap: 8px; background: var(--card-bg); padding-bottom: max(15px, env(safe-area-inset-bottom)); align-items: center; border-top: 1px solid var(--border); }
        .input-area input { flex: 1; padding: 12px 20px; border: 1px solid var(--input-border); border-radius: 25px; outline: none; font-size: 16px; background: var(--input-bg); color: var(--text-main); }
        .send-btn { background: var(--primary); color: white; border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(230,33,23,0.3); }

        /* SETTINGS MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); width: 95%; max-width: 600px; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; border: 1px solid var(--border); }
        .modal-tabs { display: flex; background: var(--card-bg); padding: 10px; border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-sec); border-radius: 12px; min-width: 80px; transition: 0.2s; font-size: 13px; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(230,33,23,0.2); }
        .tab-content { padding: 20px; overflow-y: auto; display: none; flex: 1; }
        .tab-content.active { display: block; }
        .setting-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 15px; position: relative; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-sec); margin-bottom: 5px; text-transform: uppercase; }
        .styled-input { width: 100%; padding: 10px 12px; border: 1px solid var(--input-border); border-radius: 8px; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; }
        .btn-save { flex: 2; padding: 12px; background: var(--text-main); color: var(--card-bg); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-close { flex: 1; padding: 12px; background: var(--hover-btn); color: var(--text-main); border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-remove { color: var(--red); background: rgba(231, 76, 60, 0.1); border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .prize-row { display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 10px; }
        .btn-add { width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--border); color: var(--text-sec); font-weight: 600; border-radius: 12px; cursor: pointer; margin-bottom: 20px; }
        .sticky-footer { padding: 15px; background: var(--card-bg); border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; padding-bottom: max(15px, env(safe-area-inset-bottom)); }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100%; position: absolute; }
            .main { width: 100%; height: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s; }
            
            /* Slide Animation Logic */
            body.details-open .sidebar { transform: translateX(-20%); opacity: 0; pointer-events: none; } 
            body.details-open .main { transform: translateX(0); }
            
            .back-btn { display: block; }
            .modal { align-items: flex-end; } 
            .modal-content { width: 100%; max-width: 100%; height: 85vh; border-radius: 24px 24px 0 0; margin: 0; }
            .modal-tabs { position: sticky; top: 0; z-index: 10; background: var(--card-bg); }
            .prize-row { grid-template-columns: 1fr; position: relative; border: 1px solid var(--border); padding: 10px; border-radius: 12px; }
            .prize-row .btn-remove { position: absolute; top: 10px; right: 10px; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary)">Latiao CRM</h2>
        <div class="app-switcher">
            <button class="app-switch-btn active" id="modeChatBtn" onclick="selectLoginMode('chat')">üí¨ –ß–∞—Ç</button>
            <button class="app-switch-btn" id="modeShakeBtn" onclick="selectLoginMode('shake')">üì± Shake</button>
        </div>
        <input type="text" id="loginUser" class="login-input" placeholder="–õ–æ–≥—ñ–Ω">
        <input type="password" id="loginPass" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="login-btn" onclick="authenticate()">–£–≤—ñ–π—Ç–∏</button>
    </div>
</div>

<div id="app-chat" class="app-module">
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs"><button class="tab-btn active" onclick="switchTab('settings')">–ó–∞–≥–∞–ª—å–Ω—ñ</button><button class="tab-btn" onclick="switchTab('promos')">–ü—Ä–æ–º–æ</button></div>
            <div id="tab-settings" class="tab-content active">
                <div id="managersList"></div><button onclick="addManagerField()" class="btn-add">+ –ú–µ–Ω–µ–¥–∂–µ—Ä</button>
                <div class="setting-card"><div class="input-group"><label>Bot Token</label><input type="text" id="tgTokenInput" class="styled-input"></div></div>
            </div>
            <div id="tab-promos" class="tab-content"><div id="promosList"></div><button onclick="addPromoField()" class="btn-add">+ –ü—Ä–æ–º–æ</button></div>
            <div class="sticky-footer"><button onclick="document.getElementById('settingsModal').style.display='none'" class="btn-close">–ó–∞–∫—Ä–∏—Ç–∏</button><button onclick="saveSettings()" class="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="top-row">
                <div class="user-info-box"><h2>Chat</h2></div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="document.getElementById('settingsModal').style.display='flex'">‚öôÔ∏è</button>
                    <button class="icon-btn logout-btn" onclick="logout()">üö™</button>
                </div>
            </div>
            <div class="search-box"><input type="text" id="searchInput" placeholder="–ü–æ—à—É–∫..." onkeyup="renderChatList()"></div>
        </div>
        <div class="list-container" id="chatList"></div>
    </div>

    <div class="main">
        <div class="main-header">
            <button class="back-btn" onclick="closeDetailsMobile()">‚¨Ö</button>
            <div class="main-title"><h3 id="chatUserTitle">–ß–∞—Ç</h3></div>
            <div></div>
        </div>
        <div class="content-area" id="messagesArea"></div>
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>

<div id="app-shake" class="app-module">
    
    <div id="shakeSettingsModal" class="modal">
        <div class="modal-content">
            <div style="padding:20px;border-bottom:1px solid var(--border);"><h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Shake</h3></div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <div class="setting-card">
                    <div class="input-group"><label>–®–∞–Ω—Å (%)</label><input type="number" class="styled-input" id="gameChanceInput" value="30"></div>
                    <div class="input-group"><label>–°–ø—Ä–æ–±/–¥–µ–Ω—å</label><input type="number" class="styled-input" id="gameAttemptsInput" value="3"></div>
                </div>
                <h4 style="color:var(--text-main)">–ü—Ä–∏–∑–∏</h4>
                <div id="prizesList"></div>
                <button onclick="addPrizeField()" class="btn-add">+ –î–æ–¥–∞—Ç–∏ –ø—Ä–∏–∑</button>
            </div>
            <div class="sticky-footer">
                <button onclick="document.getElementById('shakeSettingsModal').style.display='none'" class="btn-close">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button onclick="saveShakeSettings()" class="btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="top-row">
                <div class="user-info-box"><h2 style="color:var(--purple)">Shake</h2></div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="document.getElementById('shakeSettingsModal').style.display='flex'">‚öôÔ∏è</button>
                    <button class="icon-btn logout-btn" onclick="logout()">üö™</button>
                </div>
            </div>
            <div class="search-box"><input type="text" id="shakeSearch" placeholder="–ü–æ—à—É–∫ –∫–ª—ñ—î–Ω—Ç–∞..." onkeyup="renderShakeList()"></div>
        </div>
        <div class="list-container" id="shakeList"></div>
    </div>

    <div class="main">
        <div class="main-header">
            <button class="back-btn" onclick="closeDetailsMobile()">‚¨Ö</button>
            <div class="main-title"><h3 id="shakeTitle">–î–∞—à–±–æ—Ä–¥</h3></div>
            <div></div>
        </div>
        
        <div id="shakeDashboard" class="content-area dashboard-view">
            <h1 style="color:var(--text-main); margin-bottom:10px;">–ó–∞–≥–∞–ª—å–Ω–∞ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
            <div class="dash-grid">
                <div class="dash-card"><h3>–í—Å—å–æ–≥–æ –ª—ñ–¥—ñ–≤</h3><div class="dash-value" id="dashTotal" style="color:var(--purple)">0</div></div>
                <div class="dash-card"><h3>–í–∏–≥—Ä–∞—à—ñ–≤</h3><div class="dash-value" id="dashWins" style="color:var(--green)">0</div></div>
                <div class="dash-card"><h3>–°—å–æ–≥–æ–¥–Ω—ñ</h3><div class="dash-value" id="dashToday" style="color:var(--orange)">0</div></div>
            </div>
            <p style="color:var(--text-sec); margin-top:20px;">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É –∑–ª—ñ–≤–∞, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ.</p>
        </div>

        <div id="shakeClientDetails" class="content-area" style="display:none;">
            </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let selectedMode = 'chat';
    let allChats=[], managers=[], savedPrizes=[], shakeLeads=[], clientsData={};
    let currentChatId=null;

    checkSession();

    function selectLoginMode(mode) {
        selectedMode = mode;
        document.querySelectorAll('.app-switch-btn').forEach(b => b.classList.remove('active'));
        if(mode === 'chat') document.getElementById('modeChatBtn').classList.add('active'); 
        else document.getElementById('modeShakeBtn').classList.add('active');
    }

    function checkSession() {
        const storedUser = localStorage.getItem('lc_user');
        if (storedUser) {
            selectedMode = localStorage.getItem('lc_mode') || 'chat';
            initApp();
        } else { document.getElementById('loginScreen').style.display = 'flex'; }
    }

    function authenticate() {
        const login = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        db.ref('config/managers').once('value', snap => {
            const mgrs = snap.val() || [];
            let found = mgrs.find(m => m.login === login && m.password === pass);
            if (!found && login === 'admin' && pass === 'admin') found = { name: 'Admin', role: 'admin' };
            if (found) {
                localStorage.setItem('lc_user', JSON.stringify(found));
                localStorage.setItem('lc_mode', selectedMode);
                initApp();
            } else { alert('–ü–æ–º–∏–ª–∫–∞'); }
        });
    }
    function logout() { localStorage.clear(); location.reload(); }

    function initApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelectorAll('.app-module').forEach(el => el.classList.remove('active'));
        
        if (selectedMode === 'chat') {
            document.getElementById('app-chat').classList.add('active');
            initChatLogic();
        } else {
            document.getElementById('app-shake').classList.add('active');
            initShakeLogic();
        }
    }

    /* --- CHAT LOGIC --- */
    function initChatLogic() {
        // Basic chat init (abbreviated for this response as focus is on Shake UI)
        db.ref('active_chats').on('value', snap => {
            allChats = []; snap.forEach(c => allChats.push({id: c.key, ...c.val()}));
            allChats.sort((a,b)=>b.ts - a.ts);
            const list = document.getElementById('chatList'); list.innerHTML='';
            allChats.forEach(chat => {
                const div = document.createElement('div'); div.className = 'list-item';
                div.onclick = () => openChat(chat.id);
                div.innerHTML = `<div class="list-top"><span class="list-title">#${chat.id.substring(0,6)}</span></div><div class="list-desc">${chat.lastMsg || '...'}</div>`;
                list.appendChild(div);
            });
        });
    }
    
    function openChat(id) {
        currentChatId = id; document.body.classList.add('details-open');
        document.getElementById('chatUserTitle').innerText = '–ö–ª—ñ—î–Ω—Ç ' + id.substring(0,6);
        const area = document.getElementById('messagesArea'); area.innerHTML = 'Loading...';
        db.ref('support/'+id).on('value', snap => {
            area.innerHTML = '';
            snap.forEach(c => {
                const m = c.val();
                const div = document.createElement('div'); div.className = `bubble ${m.type}`;
                div.innerHTML = `<span>${m.text}</span>`;
                area.appendChild(div);
            });
        });
    }
    function sendMessage() {
        const txt = document.getElementById('msgInput').value;
        if(txt && currentChatId) {
            db.ref('support/'+currentChatId).push({text: txt, type: 'admin', ts: Date.now()});
            db.ref('active_chats/'+currentChatId).update({lastMsg: '–í–∏: '+txt, ts: Date.now()});
            document.getElementById('msgInput').value = '';
        }
    }

    /* --- SHAKE LOGIC (Unified UI) --- */
    function initShakeLogic() {
        // Load Settings
        db.ref('config/prizes').once('value', s => savedPrizes = s.val()||[]);
        db.ref('config/game_params').once('value', s => {
            const p = s.val() || {};
            document.getElementById('gameChanceInput').value = p.chance || 30;
            document.getElementById('gameAttemptsInput').value = p.attempts || 3;
        });

        // Load Data
        db.ref('shake_leads').on('value', snap => {
            shakeLeads = [];
            snap.forEach(child => shakeLeads.push(child.val()));
            if(shakeLeads.length === 0) mockShakeData(); // Demo
            processClients(shakeLeads);
            renderShakeList();
            updateShakeDashboard();
        });
    }

    function mockShakeData() {
        shakeLeads = [
            { phone: '380991234567', prize: '–ó–Ω–∏–∂–∫–∞ -15%', code: 'SHAKE15', ts: Date.now() - 3600000 },
            { phone: '380678889900', prize: '–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞', code: 'FREESHIP', ts: Date.now() - 7200000 },
            { phone: '380931112233', prize: '–°–ø—Ä–æ–±—É–π —â–µ', code: null, ts: Date.now() - 10000000 },
            { phone: '380991234567', prize: '–°–ø—Ä–æ–±—É–π —â–µ', code: null, ts: Date.now() - 4000000 }
        ];
    }

    function processClients(leads) {
        clientsData = {};
        leads.forEach(l => {
            if(!l.phone) return;
            if(!clientsData[l.phone]) clientsData[l.phone] = { phone: l.phone, history: [], wins: 0, shakes: 0, last: 0 };
            
            clientsData[l.phone].shakes++;
            if(l.ts > clientsData[l.phone].last) clientsData[l.phone].last = l.ts;
            if(l.code) clientsData[l.phone].wins++;
            
            clientsData[l.phone].history.push(l);
        });
    }

    function renderShakeList() {
        const list = document.getElementById('shakeList');
        const search = document.getElementById('shakeSearch').value.toLowerCase();
        list.innerHTML = '';
        
        const sorted = Object.values(clientsData).sort((a,b) => b.last - a.last);
        
        sorted.forEach(c => {
            if(search && !c.phone.includes(search)) return;
            const div = document.createElement('div');
            div.className = 'list-item';
            div.onclick = () => openShakeClient(c.phone);
            
            const time = new Date(c.last).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const winText = c.wins > 0 ? `<span style="color:var(--green)">–í–∏–≥—Ä–∞—à—ñ–≤: ${c.wins}</span>` : '–ë–µ–∑ –≤–∏–≥—Ä–∞—à—ñ–≤';
            
            div.innerHTML = `
                <div class="list-top"><span class="list-title">${c.phone}</span><span class="list-time">${time}</span></div>
                <div class="list-desc">${winText} ‚Ä¢ –°–ø—Ä–æ–±: ${c.shakes}</div>
            `;
            list.appendChild(div);
        });
    }

    function updateShakeDashboard() {
        document.getElementById('dashTotal').innerText = Object.keys(clientsData).length;
        let wins = 0;
        Object.values(clientsData).forEach(c => wins += c.wins);
        document.getElementById('dashWins').innerText = wins;
        
        let today = 0; const now = new Date().toDateString();
        Object.values(clientsData).forEach(c => { if(new Date(c.last).toDateString() === now) today++; });
        document.getElementById('dashToday').innerText = today;
    }

    function openShakeClient(phone) {
        document.body.classList.add('details-open');
        document.getElementById('shakeDashboard').style.display = 'none';
        
        const details = document.getElementById('shakeClientDetails');
        details.style.display = 'flex';
        document.getElementById('shakeTitle').innerText = phone;
        
        details.innerHTML = '';
        const client = clientsData[phone];
        
        // Sort history new to old
        const history = client.history.sort((a,b) => a.ts - b.ts);
        
        history.forEach(h => {
            const date = new Date(h.ts).toLocaleString();
            let html = `<span>${date}</span><br>`;
            
            const div = document.createElement('div');
            if (h.code) {
                div.className = 'bubble user'; // Green/User style for wins
                div.style.borderLeft = "4px solid var(--green)";
                html += `üéâ <b>${h.prize}</b><br>–ö–æ–¥: ${h.code}`;
            } else {
                div.className = 'bubble system'; // Gray style for losses
                html += `üé≤ –¢—Ä—É—Å–∏–≤ —Ç–µ–ª–µ—Ñ–æ–Ω (–ù–µ–≤–¥–∞—á–∞)`;
            }
            div.innerHTML = html;
            details.appendChild(div);
        });
        
        // Add UTM info if exists
        if(client.history[0].utm) {
            const utmDiv = document.createElement('div');
            utmDiv.className = 'bubble system';
            utmDiv.innerHTML = `UTM: ${client.history[0].utm.source || 'Direct'}`;
            details.appendChild(utmDiv);
        }
    }

    function closeDetailsMobile() {
        document.body.classList.remove('details-open');
        // Optional: Reset view to dashboard when closing on desktop logic, but for mobile slide out it's enough
    }

    /* --- SHAKE SETTINGS --- */
    function addPrizeField(name='', code='', chance='') {
        const div = document.createElement('div'); div.className = 'prize-row';
        div.innerHTML = `
            <div class="input-group"><label>–ù–∞–∑–≤–∞</label><input type="text" class="styled-input prize-name" value="${name}"></div>
            <div class="input-group"><label>–ö–æ–¥</label><input type="text" class="styled-input prize-code" value="${code}"></div>
            <div class="input-group"><label>%</label><input type="number" class="styled-input prize-chance" value="${chance}"></div>
            <button onclick="this.parentElement.remove()" class="btn-remove">‚úï</button>
        `;
        document.getElementById('prizesList').appendChild(div);
    }
    function saveShakeSettings() {
        const newPrizes = [];
        document.querySelectorAll('.prize-row').forEach(el => {
            const name = el.querySelector('.prize-name').value;
            const code = el.querySelector('.prize-code').value;
            const chance = el.querySelector('.prize-chance').value;
            if(name) newPrizes.push({name, code, chance: parseInt(chance)});
        });
        const c = document.getElementById('gameChanceInput').value;
        const a = document.getElementById('gameAttemptsInput').value;
        db.ref('config/prizes').set(newPrizes);
        db.ref('config/game_params').set({chance: parseInt(c), attempts: parseInt(a)});
        document.getElementById('shakeSettingsModal').style.display='none';
    }
    // Load Prizes UI
    function renderPrizes() {
        const l = document.getElementById('prizesList'); l.innerHTML='';
        savedPrizes.forEach(p => addPrizeField(p.name, p.code, p.chance));
    }
    document.querySelector('.icon-btn[onclick*="shakeSettingsModal"]').onclick = () => {
        document.getElementById('shakeSettingsModal').style.display='flex';
        renderPrizes();
    };
</script>

</body>
</html>
