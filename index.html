<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latiao Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #e62117;
            --bg-chrome: #dfe1e5;
            --bg-app: #f1f3f4;
            --sidebar-w: 320px;
            --header-h: 80px; /* –í–∏—Å–æ—Ç–∞ —à–∞–ø–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ */
        }

        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #000; height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        /* --- –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –ø—ñ–¥ Chrome Browser --- */
        .chrome-window {
            width: 100%; height: 100%;
            background: #fff;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* –Ø–∫—â–æ –µ–∫—Ä–∞–Ω –≤–µ–ª–∏–∫–∏–π, —Ä–æ–±–∏–º–æ –≤—ñ–¥—Å—Ç—É–ø–∏, —â–æ–± –≤–∏–≥–ª—è–¥–∞–ª–æ —è–∫ –≤—ñ–∫–Ω–æ */
        @media (min-width: 1000px) {
            .chrome-window {
                width: 90%; height: 90%;
                border-radius: 8px;
                box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            }
        }

        .chrome-header {
            background: #dfe1e5;
            padding-top: 8px;
            flex-shrink: 0;
            display: flex; flex-direction: column;
        }

        .tabs-bar {
            display: flex; align-items: center; padding: 0 10px; gap: 8px;
        }
        .window-controls { display: flex; gap: 6px; margin-right: 15px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27c93f; }

        .chrome-tab {
            background: #fff;
            padding: 8px 20px;
            border-radius: 8px 8px 0 0;
            font-size: 12px; color: #333;
            display: flex; align-items: center; gap: 8px;
            position: relative;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .chrome-tab::after {
            content: ''; position: absolute; right: -15px; bottom: 0; width: 15px; height: 15px;
            background: radial-gradient(circle at top right, transparent 15px, #fff 0);
        }
        .chrome-tab::before {
            content: ''; position: absolute; left: -15px; bottom: 0; width: 15px; height: 15px;
            background: radial-gradient(circle at top left, transparent 15px, #fff 0);
        }

        .address-bar-row {
            background: #fff; padding: 6px 10px; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; gap: 10px;
        }
        .nav-icons { color: #5f6368; font-size: 14px; display: flex; gap: 10px; }
        .url-bar {
            flex: 1; background: #f1f3f4; border-radius: 20px;
            padding: 6px 15px; font-size: 13px; color: #202124;
            display: flex; align-items: center; gap: 8px;
        }
        .secure-lock { color: #1a73e8; font-size: 12px; }

        /* --- –û—Å–Ω–æ–≤–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ Admin Panel --- */
        .admin-body {
            flex: 1; display: flex; overflow: hidden; position: relative;
        }

        /* –°–∞–π–¥–±–∞—Ä (–°–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤) */
        .sidebar {
            width: var(--sidebar-w);
            border-right: 1px solid #eee;
            background: #f8f9fa;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 2;
        }
        
        .sidebar-header {
            padding: 20px; border-bottom: 1px solid #eee;
        }
        .sidebar-header h2 { margin: 0; font-size: 18px; color: #333; }
        .stats { font-size: 12px; color: #888; margin-top: 5px; }

        .chat-list {
            flex: 1; overflow-y: auto;
        }
        
        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        .chat-item:hover { background: #fff; }
        .chat-item.active { background: #fff; border-left: 4px solid var(--primary); }
        
        .chat-item-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .user-id { font-weight: 600; font-size: 14px; color: #333; }
        .msg-time { font-size: 11px; color: #999; }
        .last-msg { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .new-indicator {
            width: 8px; height: 8px; background: var(--primary); border-radius: 50%;
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            display: none;
        }
        .chat-item.unread .new-indicator { display: block; }
        .chat-item.unread .user-id { color: var(--primary); }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç—É */
        .chat-area {
            flex: 1; display: flex; flex-direction: column; background: #fff;
            position: relative;
        }
        
        /* –ó–∞–≥–ª—É—à–∫–∞, –∫–æ–ª–∏ —á–∞—Ç –Ω–µ –≤–∏–±—Ä–∞–Ω–æ */
        .empty-state {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #ccc;
        }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.2; }

        /* –í–º—ñ—Å—Ç —á–∞—Ç—É */
        .chat-view {
            display: none; flex-direction: column; height: 100%;
        }
        .chat-view.visible { display: flex; }

        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            background: #fff;
        }
        .back-btn { display: none; background: none; border: none; font-size: 20px; cursor: pointer; margin-right: 10px; }
        
        .messages-container {
            flex: 1; padding: 20px; overflow-y: auto; background: #fdfdfd;
            display: flex; flex-direction: column; gap: 10px;
        }

        .msg {
            max-width: 70%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4;
            position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .msg.user {
            align-self: flex-start; background: #f0f0f0; color: #333;
            border-bottom-left-radius: 2px;
        }
        .msg.admin {
            align-self: flex-end; background: var(--primary); color: #fff;
            border-bottom-right-radius: 2px;
        }
        .msg-ts { font-size: 10px; margin-top: 4px; opacity: 0.7; text-align: right; display: block; }

        .input-area {
            padding: 15px; border-top: 1px solid #eee; background: #fff;
            display: flex; gap: 10px;
        }
        .input-area input {
            flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 24px;
            outline: none; font-size: 14px; transition: 0.2s;
        }
        .input-area input:focus { border-color: var(--primary); }
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; background: var(--primary);
            color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .send-btn:hover { transform: scale(1.05); }

        /* --- –ú–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .chat-area { width: 100%; position: absolute; height: 100%; transform: translateX(100%); transition: transform 0.3s ease; }
            
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block; }
            
            /* Chrome header adjustments for mobile */
            .chrome-tab { max-width: 150px; }
            .url-bar { font-size: 11px; }
        }
    </style>
</head>
<body>

<div class="chrome-window">
    <div class="chrome-header">
        <div class="tabs-bar">
            <div class="window-controls">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
            </div>
            <div class="chrome-tab">
                <span>Latiao Support Admin</span>
                <span style="font-size: 10px; cursor:pointer">‚úï</span>
            </div>
            <div style="font-size: 18px; color: #5f6368; margin-left: auto;">+</div>
        </div>
        <div class="address-bar-row">
            <div class="nav-icons">
                <span>‚Üê</span><span>‚Üí</span><span>‚Üª</span>
            </div>
            <div class="url-bar">
                <span class="secure-lock">üîí</span>
                latiao-snack.com/admin/support
            </div>
        </div>
    </div>

    <div class="admin-body">
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>–í—Ö—ñ–¥–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h2>
                <div class="stats" id="chat-stats">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            </div>
            <div class="chat-list" id="chat-list">
                </div>
        </div>

        <div class="chat-area" id="chat-area">
            
            <div class="empty-state" id="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                </svg>
                <p>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –¥–ª—è —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è</p>
            </div>

            <div class="chat-view" id="chat-view">
                <div class="chat-header">
                    <div style="display:flex; align-items:center;">
                        <button class="back-btn" onclick="closeChat()">‚Üê</button>
                        <div>
                            <strong id="current-user-id" style="font-size:16px;">User</strong>
                            <div style="font-size:11px; color:#27c93f;">‚Ä¢ –û–Ω–ª–∞–π–Ω</div>
                        </div>
                    </div>
                    <button onclick="deleteChat()" style="color:#e62117; background:none; border:none; cursor:pointer; font-size:12px;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
                
                <div class="messages-container" id="messages-container">
                    </div>

                <form class="input-area" onsubmit="sendAdminMessage(event)">
                    <input type="text" id="admin-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." autocomplete="off">
                    <button type="submit" class="send-btn">‚û§</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
    const firebaseConfig = { databaseURL: "https://latiao-chat-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ó–≤—É–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const notificationSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3');

    let currentChatId = null;
    let messagesListener = null;

    // --- –õ–û–ì–Ü–ö–ê –°–ü–ò–°–ö–£ –ß–ê–¢–Ü–í ---
    const chatListEl = document.getElementById('chat-list');
    const statsEl = document.getElementById('chat-stats');

    db.ref('active_chats').on('value', snap => {
        const chats = [];
        snap.forEach(child => {
            chats.push({ id: child.key, ...child.val() });
        });

        // –°–æ—Ä—Ç—É—î–º–æ: –Ω–∞–π–Ω–æ–≤—ñ—à—ñ –∑–≤–µ—Ä—Ö—É
        chats.sort((a, b) => b.ts - a.ts);

        statsEl.innerText = `–ê–∫—Ç–∏–≤–Ω–∏—Ö –¥—ñ–∞–ª–æ–≥—ñ–≤: ${chats.length}`;
        renderChatList(chats);
    });

    function renderChatList(chats) {
        chatListEl.innerHTML = '';
        chats.forEach(chat => {
            const date = new Date(chat.ts);
            const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
            const isToday = new Date().toDateString() === date.toDateString();
            const dateStr = isToday ? timeStr : date.toLocaleDateString();

            const div = document.createElement('div');
            div.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
            div.onclick = () => loadChat(chat.id);
            
            div.innerHTML = `
                <div class="chat-item-top">
                    <span class="user-id">${chat.id.substring(0, 10)}...</span>
                    <span class="msg-time">${dateStr}</span>
                </div>
                <div class="last-msg">${chat.lastMsg || '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è/–§–∞–π–ª'}</div>
                <div class="new-indicator"></div>
            `;
            chatListEl.appendChild(div);
        });
    }

    // --- –õ–û–ì–Ü–ö–ê –û–ö–†–ï–ú–û–ì–û –ß–ê–¢–£ ---
    function loadChat(userId) {
        currentChatId = userId;
        
        // UI updates
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('chat-view').classList.add('visible');
        document.getElementById('current-user-id').innerText = userId;
        
        // Mobile UI slide
        if (window.innerWidth <= 768) {
            document.getElementById('chat-area').classList.add('active');
        }

        // Highlight in list
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        // (–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏, –∞–ª–µ —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ)

        // Unsubscribe prev
        if (messagesListener) messagesListener.off();

        const container = document.getElementById('messages-container');
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

        // Subscribe new
        messagesListener = db.ref('support/' + userId);
        messagesListener.on('value', snap => {
            container.innerHTML = '';
            let lastMsgType = '';
            
            snap.forEach(child => {
                const m = child.val();
                renderMessage(m, container);
                lastMsgType = m.type;
                
                // Mark user msgs as read (logic mockup)
                if (m.type === 'user' && !m.read) {
                    child.ref.update({ read: true });
                }
            });
            
            container.scrollTop = container.scrollHeight;
            
            // Play sound if new message is from user and we are looking at it
            if(lastMsgType === 'user') {
                // notificationSound.play().catch(e => {}); 
            }
        });
    }

    function renderMessage(msg, container) {
        const div = document.createElement('div');
        div.className = `msg ${msg.type}`;
        
        const date = new Date(msg.ts);
        const time = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');

        div.innerHTML = `
            ${msg.text}
            <span class="msg-ts">${time}</span>
        `;
        container.appendChild(div);
    }

    // --- –í–Ü–î–ü–†–ê–í–ö–ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ---
    function sendAdminMessage(e) {
        e.preventDefault();
        const input = document.getElementById('admin-input');
        const text = input.value.trim();
        
        if (!text || !currentChatId) return;

        const ts = Date.now();

        // 1. Push message to conversation
        db.ref('support/' + currentChatId).push({
            text: text,
            type: 'admin',
            ts: ts,
            read: true
        });

        // 2. Update active chats list preview
        db.ref('active_chats/' + currentChatId).update({
            lastMsg: '–í–∏: ' + text,
            ts: ts
        });

        input.value = '';
    }

    // --- –ú–û–ë–Ü–õ–¨–ù–ê –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ---
    function closeChat() {
        document.getElementById('chat-area').classList.remove('active');
        setTimeout(() => {
            currentChatId = null;
            if(messagesListener) messagesListener.off();
            document.getElementById('chat-view').classList.remove('visible');
            document.getElementById('empty-state').style.display = 'flex';
        }, 300);
    }

    function deleteChat() {
        if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ü—å–æ–≥–æ —á–∞—Ç—É?')) return;
        db.ref('support/' + currentChatId).remove();
        db.ref('active_chats/' + currentChatId).remove();
        closeChat();
    }

</script>

</body>
</html>
